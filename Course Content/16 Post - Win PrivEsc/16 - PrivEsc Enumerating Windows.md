
>Obtaining privileged access on every machine in a penetration test is rarely a useful or realistic goal. While most machines in the challenge labs of this course are rootable, we'll face numerous non-rootable machines in real-life assessments. A skilled penetration tester's goal is therefore not to blindly attempt privilege escalation on every machine at any cost, but to identify machines where privileged access leads to further compromise of the client's infrastructure.

# Privileges and Mechanisms

## SID
- Security Identifier
- Unique value assigned to each entity, or *principal*, that can be authenticated by Windows, such as users and groups
- Local accounts and groups generated by _Local Security Authority_ (LSA)
- Domain users and domain groups generated by _Domain Controller_ (DC)

#### SID structure: `S-R-X-Y`

S - Means the string is an SID
R - Revision (always set to 1 as overall SID structure continues to be on its initial version)
X - Determines the identifier authority (authority that issues the SID ie: 5 = *NT Authority* used for local or domain users or groups)
Y - Sub-authorities of the identifier authority
	- Consists of domain identifier and relative identifier (RID)

#### RID
- Domain identifier is the SID of the domain for domain users, the SID of the local machine for local users, and "32" for built-in principals.
- RID determines principals such as users or groups.
	- Starts at 1000 for all (nearly) principles
		- Therefore, an RID of 1001 suggests the second local user created on the system


#### Well-known SIDs
SIDs with an RID under 1000 are *well-known SIDs*
- identify generic and built-in groups and users instead of specific groups and users

| SID w/ RID                 | Built-in users/ groups |
| -------------------------- | ---------------------- |
| S-1-0-0                    | Nobody                 |
| S-1-1-0                    | Everybody              |
| S-1-5-11                   | Authenticated Users    |
| S-1-5-18                   | Local System           |
| S-1-5-domainidentifier-500 | Administrator          |

## Access Token

Once a user is authenticated, Windows generates an access token that is assigned to that user.
- Contains info effectively describing the *security context* of that user

#### Security context  
- Set of rules or attributes currently in effect.
- Consists of:
	- SID of user
	- SIDs of groups user's a member of
	- User and groups privileges
	- Info describing the scope of the token

#### Primary Token
- Assigned to a process object or thread object started by a user
- Specifies which permissions the process or thread have when interacting with another object
- Is a copy of the access token of the user

#### Impersonation Token
- Assigned to a thread to provide a different security context than the process that owns said thread.
- Thread will interact with objects on behalf of the Impersonation Token rather than its process' Primary Token


## Mandatory Integrity Control

*Integrity Levels* control access to securable objects
- Hierarchies of trust Windows has in running an application or securable object

When a process is started or an object created, it's given the integrity level of the principle performing the operation
- Exception:  If an executable file has a low integrity level, the process's integrity level will also be low
- A principle with lower integrity level cannot write to an object with a higher level (even if perms would normally allow it to)

Windows Vista & onwards run on 5 integrity levels

| Level     |                                                                                                                           |
| --------- | ------------------------------------------------------------------------------------------------------------------------- |
| System    | SYSTEM (kernel, ...)                                                                                                      |
| High      | Elevated users                                                                                                            |
| Medium    | Standard users                                                                                                            |
| Low       | Very restricted rights often used in sandboxed\[^privesc_win_sandbox] processes or for directories storing temporary data |
| Untrusted | Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk    |
- Can display the integrity level of processes with _Process Explorer_ for our current user with _whoami /groups_, and for files with [_icacls_](OS%20Commands.md#icacls)

PowerShell process has two Integrity Levels:
- High - Administrator
- Medium - regular user


## User Account Control

Windows security feature which protects the OS by running most apps and tasks with standard user privileges even when started as an Admin

For this, an Admin user obtains two access tokens on successful login
- Standard user token (*Filtered admin token*)
	- Used to perform all non-privileged operations
- Regular admin token
	- Used when user wants to perform a privileged operation
	- To leverage, a UAC prompt will appear asking for task/ process confirmation


# Situational Awareness

Before attempting to elevate privileges, you must obtain info about the system you're on
- Crucial to understand the nature of the compromised system and discover possible vectors for privesc (&/or lateral movement)

### Key pieces of Info

#### Username and hostname
```powershell
whoami
	clientwk220\dave
# Shows username is dave and hostname is clientwk220 suggesting a workstation (rather than a server)
```


#### Group memberships of the current user (dave)
```powershell
whoami /groups

GROUP INFORMATION
-----------------
Group Name                           Type             SID                                            Attributes                                        
==================================== ================ ============================================== ==================================================
Everyone                             Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
CLIENTWK220\helpdesk                 Alias            S-1-5-21-2309961351-4093026482-2223492918-1008 Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users         Alias            S-1-5-32-555                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\BATCH                   Well-known group S-1-5-3                                        Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account           Well-known group S-1-5-113                                      Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288 
```
	- Note he's part of the helpdesk and RDP groups
		- Helpdesk staff often have additional permissions and access compared to standard users.

#### Existing users and groups
```powershell
# Enumerate existing users on the machine
PS C:\Users\dave> Get-LocalUser
	Name               Enabled Description                                                                                 
	----               ------- -----------                                                                                 
	Administrator      False   Built-in account for administering the computer/domain                                      
	BackupAdmin        True                                                                                                
	dave               True    dave                                                                                        
	daveadmin          True                                                                                                
	DefaultAccount     False   A user account managed by the system.                                                       
	Guest              False   Built-in account for guest access to the computer/domain                                    
	offsec             True                                                                                                
	steve              True                                                                                                
	WDAGUtilityAccount False   A user account managed and used by the system for Windows Defender Application Guard
```
	- Shows built-in Admin & Guest accounts are disabled
	- offsec & steve are two additional regular users
	- daveadmin and BackupAdmin are two (likely) privileged accounts
		- Admins typically have two users - regular for day-to-day stuff & admin for privileged operations

``` powershell
# Enumerate existing groups on the machine
# If using cmd prompt: net localgroup
PS C:\Users\dave> Get-LocalGroup 
	Name                                Description                                                                        
	----                                -----------                                                                        
	adminteam                           Members of this group are admins to all workstations on the second floor           
	BackupUsers                                                                                                            
	helpdesk                                                                                                               
	...
	Administrators                      Administrators have complete and unrestricted access to the computer/domain        
	...
	Remote Desktop Users                Members in this group are granted the right to logon remotely
	Remote Management Users             Members of this group can access WMI resources over management protocols (such a...                     
	...
```
	- Displays non-standard groups: adminteam, BackupUsers, helpdesk
	- adminteam may be of interest - has its own description (admins to all of 2nd floor)- though we don't know floor structure
	- Backup solutions (BackupAdmin user and BackupUsers group) often have extensive permissions to perform their operations on the file system, making it & the adminteam group potentially valuable targets.

Built in groups that should be analyzed:
- _Administrators_
- _Backup Operators_
	- Can backup and restore all files on a computer, even those files they don't have permissions for (not to be confused w/ non-standard BackupUsers group here)
- _Remote Desktop Users_
	- Can access a system with RDP
- _Remote Management Users_
	- Can access a system with [WinRM](Tools.md#WinRM)

```powershell
# Enumerate through groups' members
PS C:\Users\dave> Get-LocalGroupMember adminteam
	ObjectClass Name                  PrincipalSource
	----------- ----                  ---------------
	User        CLIENTWK220\daveadmin Local

PS C:\Users\dave> Get-LocalGroupMember Administrators
	ObjectClass Name                      PrincipalSource
	----------- ----                      ---------------
	User        CLIENTWK220\Administrator Local          
	User        CLIENTWK220\BackupAdmin   Local          
	User        CLIENTWK220\daveadmin     Local          
	User        CLIENTWK220\offsec        Local

PS C:\Users\dave> Get-LocalGroupMember "Remote Desktop Users"
	ObjectClass Name              PrincipalSource
	----------- ----              ---------------
	User        CLIENTWK220\dave  Local          
	User        CLIENTWK220\steve Local
```
	- Only daveadmin is a member of adminteam (& therefore has Admin privileges on all workstations on 2nd floor)
	- adminteam isn't a member of the Admin group
	- daveadmin and BackupAdmin are local Admins
	- dave and steve have RDP abilities

#### Operating system, version and architecture
```powershell
# Get info on system
PS C:\Users\dave> systeminfo
	Host Name:                 CLIENTWK220
	OS Name:                   Microsoft Windows 11 Pro
	OS Version:                10.0.22000 N/A Build 22000
	...
	System Type:               x64-based PC
```
	- Our shell runs on a Win 11 Pro 64-bit system
	- Build 22000 is the version _21H2_ of Windows 11

#### Network information
- Goal in this step is to identify all network interfaces, routes, and active network connections.
- Based on this info, may ID new services or even access to other networks.
	- May not directly lead us to elevated privileges, but they are vital to understand the machine's purpose and to obtain vectors to other systems and networks.
```powershell
# Enumerate network info
PS C:\Users\dave> ipconfig /all
	Windows IP Configuration
	
	   Host Name . . . . . . . . . . . . : clientwk220
	   Primary Dns Suffix  . . . . . . . : 
	   Node Type . . . . . . . . . . . . : Hybrid
	   IP Routing Enabled. . . . . . . . : No
	   WINS Proxy Enabled. . . . . . . . : No
	
	Ethernet adapter Ethernet0:
	
	   Connection-specific DNS Suffix  . : 
	   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter
	   Physical Address. . . . . . . . . : 00-50-56-BF-52-14
	   DHCP Enabled. . . . . . . . . . . : No
	   Autoconfiguration Enabled . . . . : Yes
	   Link-local IPv6 Address . . . . . : fe80::1405:9da5:a2ef:76a0%6(Preferred) 
	   IPv4 Address. . . . . . . . . . . : 192.168.179.220(Preferred) 
	   Subnet Mask . . . . . . . . . . . : 255.255.255.0
	   Default Gateway . . . . . . . . . : 192.168.179.254
	   DHCPv6 IAID . . . . . . . . . . . : 234901590
	   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2D-97-3E-74-00-50-56-BF-BA-AD
	   DNS Servers . . . . . . . . . . . : 192.168.179.254
	   NetBIOS over Tcpip. . . . . . . . : Enabled
```
	- System has a manually set static IP & doesn't use DHCP
	- Info also contains MAC address, subnet mask, gateway, and DNS server
		- Useful for lateral movement

```powershell
# Display routing table - possible attack vectors to other systems or networks
PS C:\Users\dave>route print
	===========================================================================
	Interface List
	  6...00 50 56 bf 7b 8e ......vmxnet3 Ethernet Adapter
	  1...........................Software Loopback Interface 1
	===========================================================================
	
	IPv4 Route Table
	===========================================================================
	Active Routes:
	Network Destination        Netmask          Gateway       Interface  Metric
	          0.0.0.0          0.0.0.0  192.168.233.254  192.168.233.220     16
	        127.0.0.0        255.0.0.0         On-link         127.0.0.1    331
	        127.0.0.1  255.255.255.255         On-link         127.0.0.1    331
	  127.255.255.255  255.255.255.255         On-link         127.0.0.1    331
	    192.168.233.0    255.255.255.0         On-link   192.168.233.220    271
	  192.168.233.220  255.255.255.255         On-link   192.168.233.220    271
	  192.168.233.255  255.255.255.255         On-link   192.168.233.220    271
	        224.0.0.0        240.0.0.0         On-link         127.0.0.1    331
	        224.0.0.0        240.0.0.0         On-link   192.168.233.220    271
	  255.255.255.255  255.255.255.255         On-link         127.0.0.1    331
	  255.255.255.255  255.255.255.255         On-link   192.168.233.220    271
	===========================================================================
	Persistent Routes:
	  Network Address          Netmask  Gateway Address  Metric
	          0.0.0.0          0.0.0.0  192.168.233.254       1
	===========================================================================
	
	IPv6 Route Table
	===========================================================================
	Active Routes:
	 If Metric Network Destination      Gateway
	  1    331 ::1/128                  On-link
	  6    271 fe80::/64                On-link
	  6    271 fe80::3d61:d09c:8464:b785/128
	                                    On-link
	  1    331 ff00::/8                 On-link
	  6    271 ff00::/8                 On-link
	===========================================================================
	Persistent Routes:
	  None
```
	- Sadly no previously unknown networks

```powershell
# Enumerate all active (-a) netconns without name resolution (-n) showing process id (-o)
PS C:\Users\dave> netstat -ano
Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       2668
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       944
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       2668
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       2836
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       632
  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING       3040
  ...
  TCP    192.168.233.220:139    0.0.0.0:0              LISTENING       4
  TCP    192.168.233.220:3389   192.168.119.4:33060    ESTABLISHED     1084
  TCP    192.168.233.220:4444   192.168.45.156:50148   ESTABLISHED     2708
```
	- 80 & 443 listening suggest website
	- 3306 points to a MySQL server
	- Established connection via RDP means another user is connected to the system
		- Once privs are escalated, can attempt to dump creds

#### Installed applications
```powershell
# Enumerate 36-bit applications
PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
	displayname                                                       
	-----------
	KeePass Password Safe 2.51.1                                      
	Microsoft Edge                                                    
	Microsoft Edge Update                                             
	Microsoft Edge WebView2 Runtime                                   
	
	Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.28.29913
	Microsoft Visual C++ 2019 X86 Additional Runtime - 14.28.29913    
	Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.28.29913       
	Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29913

# Enumerate 64-bit applications
PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
	DisplayName                                                   
	-----------                                                   
	7-Zip 21.07 (x64)                                             
	   
	XAMPP                                                         
	VMware Tools                                                  
	Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29913
	Microsoft Update Health Tools                                 
	Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.28.29913
```
	- Shows that KeePass, 7-Zip, and XAMPP are installed
		- Can search for public exploits after system enumeration
		- Getting master password for KeePass could net us more passwords for other logins
	- Listing may not be complete, ALWAYS check C:\Program Files and Downloads folders

#### Running processes
```powershell
PS C:\Users\dave> Get-Process
Get-Process

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName                                                  
-------  ------    -----      -----     ------     --  -- -----------                                                  
     53      13      536       1176       0.03   2708   0 access                                                       
    ...                                                  
    183      29     9528      19788              2668   0 httpd                                                        
    481      49    16568      23068              3828   0 httpd                                                        
    ...                                                      
    176      16   210496      28696              2836   0 mysqld                                                       
    742      27    73940      13536       0.48   6092   0 powershell                                                   
    ...                                                     
    215      17     5596      17128               412   0 xampp-control
```
	- Our bind shell 'access' ID 2708
	- Powershell session used to enumerate ID 6092
	- MySQL daemon ID 2836
	- Apache's httpd ID 3828
	- As 'xampp-control' ID 412 is running, shows Apache and MySQL were started through XAMPP


# "Passwords on a Sticky Note"

Sensitive information may be stored in meeting notes, configuration files, or onboarding documents.

Given what was found during previous enumeration (KeePass & XAMPP), search for password manager databases and configuration files of these apps.
- KeePass stores databases in *.kdbx* files
- XAMPP stores config files in *.txt* and *.ini* files
```powershell
# Find KeePass databases
PS C:\Users\dave> Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
# No results shows that no KeePass databases can be found

# Search for sensitive info in the XAMPP config files
PS C:\Users\dave> Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
	...
	    Directory: C:\xampp\mysql\bin
	Mode                 LastWriteTime         Length Name                                                                 
	----                 -------------         ------ ----                                                                 
	-a----         6/22/2022  10:52 AM           5824 my.ini   #<-- Config file for MySQL
	...
	
	    Directory: C:\xampp
	Mode                 LastWriteTime         Length Name                                                                 
	----                 -------------         ------ ----                                                                 
	-a----         3/13/2017   4:04 AM            824 passwords.txt                                                        
	...

# Read password file
PS C:\Users\dave> gc c:\xampp\passwords.txt
	### XAMPP Default Passwords ###
	
	1) MySQL (phpMyAdmin):
	
	   User: root
	   Password:
	   (means no password!)
	
	2) FileZilla FTP:
	
	   [ You have to create a new user on the FileZilla Interface ] 
	
	3) Mercury (not in the USB & lite version): 
	
	   Postmaster: Postmaster (postmaster@localhost)
	   Administrator: Admin (admin@localhost)
	
	   User: newuser  
	   Password: wampp 
	
	4) WEBDAV: 
	
	   User: xampp-dav-unsecure
	   Password: ppmax2011
	   Attention: WEBDAV is not active since XAMPP Version 1.7.4.
	   For activation please comment out the httpd-dav.conf and
	   following modules in the httpd.conf
	   
	   LoadModule dav_module modules/mod_dav.so
	   LoadModule dav_fs_module modules/mod_dav_fs.so  
	   
	   Please do not forget to refresh the WEBDAV authentification (users and passwords).

# Read my.ini
PS C:\Users\dave> gc c:\xampp\mysql\bin\my.ini
	gc : Access to the path 'C:\xampp\mysql\bin\my.ini' is denied.
```
	- Unfortunately, passwords.txt only contains default password settings & reading the my.ini file is denied

- As that was a bust, search for files in the user's directory
```powershell
PS C:\Users\dave> Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
	Directory: C:\users\dave\Desktop
	
	Mode                 LastWriteTime         Length Name                                                                 
	----                 -------------         ------ ----                                                                 
	-a----         6/16/2022  11:28 AM            339 asdf.txt

PS C:\Users\dave> gc c:\users\dave\Desktop\asdf.txt
	notes from meeting:
	
	- Contractors won't deliver the web app on time
	- Login will be done via local user credentials
	- I need to install XAMPP and a password manager on my machine 
	- When beta app is deployed on my local pc: 
	Steve (the guy with long shirt) gives us his password for testing
	password is: securityIsNotAnOption++++++
```
	- Steve's password is securityIsNotAnOption++++++

- Before leveraging the password, check what group Steve's in
```powershell
PS C:\Users\dave> net user steve
	...
	Password last set            6/16/2022 12:08:00 PM
	Password expires             Never
	Password changeable          6/16/2022 12:08:00 PM
	Password required            Yes
	User may change password     Yes
	
	Workstations allowed         All
	...
	Local Group Memberships      *helpdesk             *Remote Desktop Users 
	                             *Remote Management Use*Users                
	Global Group memberships     *None                 
	The command completed successfully.
```
	- steve isn't an Admin, but he does have RDP access

- RDP'ing in as `steve` starts the whole Discovery process all over again
	- While we're on the same endpoint, we don't need to redo process, network, etc enumeration, we will need to look through the user's info
- Given we couldn't access the *my.ini* file with `dave`, we should now test with `steve`
```powershell
PS C:\Users\steve> gc C:\xampp\mysql\bin\my.ini
	# The following options will be passed to all MySQL clients
	# backupadmin Windows password for backup job
	[client]
	password       = admin123admin123!
	port=3306
```
	- Not only did we find the password, but we've discovered that it's the password for *backupadmin* user

- Find out what groups `backupadmin` user is a part of
```powershell
PS C:\Users\steve> net user backupadmin
	...
	Local Group Memberships      *Administrators    *BackupUsers    *Users
	Global Group memberships     *None
```
	- *backupadmin* is part of Admin group, but not RDP or Remote Management Users

- As we have a GUI, we can use `runAs` to open up a command prompt as the `backupadmin` user
```powershell
runAs /user:backupadmin cmd
	Enter the password for backupadmin: <Enter admin123admin123!>
	Attempting to start cmd as user "CLIENTWK220\backupadmin" ...

	C:\Windows\system32>whoami
		clientwk220\backupadmin
```

