
>Obtaining privileged access on every machine in a penetration test is rarely a useful or realistic goal. While most machines in the challenge labs of this course are rootable, we'll face numerous non-rootable machines in real-life assessments. A skilled penetration tester's goal is therefore not to blindly attempt privilege escalation on every machine at any cost, but to identify machines where privileged access leads to further compromise of the client's infrastructure.

# Privileges and Mechanisms

## SID
- Security Identifier
- Unique value assigned to each entity, or *principal*, that can be authenticated by Windows, such as users and groups
- Local accounts and groups generated by _Local Security Authority_ (LSA)
- Domain users and domain groups generated by _Domain Controller_ (DC)

#### SID structure: `S-R-X-Y`

S - Means the string is an SID
R - Revision (always set to 1 as overall SID structure continues to be on its initial version)
X - Determines the identifier authority (authority that issues the SID ie: 5 = *NT Authority* used for local or domain users or groups)
Y - Sub-authorities of the identifier authority
	- Consists of domain identifier and relative identifier (RID)

#### RID
- Domain identifier is the SID of the domain for domain users, the SID of the local machine for local users, and "32" for built-in principals.
- RID determines principals such as users or groups.
	- Starts at 1000 for all (nearly) principles
		- Therefore, an RID of 1001 suggests the second local user created on the system


#### Well-known SIDs
SIDs with an RID under 1000 are *well-known SIDs*
- identify generic and built-in groups and users instead of specific groups and users

| SID w/ RID                 | Built-in users/ groups |
| -------------------------- | ---------------------- |
| S-1-0-0                    | Nobody                 |
| S-1-1-0                    | Everybody              |
| S-1-5-11                   | Authenticated Users    |
| S-1-5-18                   | Local System           |
| S-1-5-domainidentifier-500 | Administrator          |

## Access Token

Once a user is authenticated, Windows generates an access token that is assigned to that user.
- Contains info effectively describing the *security context* of that user

#### Security context  
- Set of rules or attributes currently in effect.
- Consists of:
	- SID of user
	- SIDs of groups user's a member of
	- User and groups privileges
	- Info describing the scope of the token

#### Primary Token
- Assigned to a process object or thread object started by a user
- Specifies which permissions the process or thread have when interacting with another object
- Is a copy of the access token of the user

#### Impersonation Token
- Assigned to a thread to provide a different security context than the process that owns said thread.
- Thread will interact with objects on behalf of the Impersonation Token rather than its process' Primary Token


## Mandatory Integrity Control

*Integrity Levels* control access to securable objects
- Hierarchies of trust Windows has in running an application or securable object

When a process is started or an object created, it's given the integrity level of the principle performing the operation
- Exception:  If an executable file has a low integrity level, the process's integrity level will also be low
- A principle with lower integrity level cannot write to an object with a higher level (even if perms would normally allow it to)

Windows Vista & onwards run on 5 integrity levels

| Level     |                                                                                                                           |
| --------- | ------------------------------------------------------------------------------------------------------------------------- |
| System    | SYSTEM (kernel, ...)                                                                                                      |
| High      | Elevated users                                                                                                            |
| Medium    | Standard users                                                                                                            |
| Low       | Very restricted rights often used in sandboxed\[^privesc_win_sandbox] processes or for directories storing temporary data |
| Untrusted | Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk    |
- Can display the integrity level of processes with _Process Explorer_ for our current user with _whoami /groups_, and for files with [_icacls_](OS%20Commands.md#icacls)

PowerShell process has two Integrity Levels:
- High - Administrator
- Medium - regular user


## User Account Control

Windows security feature which protects the OS by running most apps and tasks with standard user privileges even when started as an Admin

For this, an Admin user obtains two access tokens on successful login
- Standard user token (*Filtered admin token*)
	- Used to perform all non-privileged operations
- Regular admin token
	- Used when user wants to perform a privileged operation
	- To leverage, a UAC prompt will appear asking for task/ process confirmation


# Situational Awareness

Before attempting to elevate privileges, you must obtain info about the system you're on
- Crucial to understand the nature of the compromised system and discover possible vectors for privesc (&/or lateral movement)

### Key pieces of Info

#### Username and hostname
```powershell
whoami
	clientwk220\dave
# Shows username is dave and hostname is clientwk220 suggesting a workstation (rather than a server)
```

#### Group memberships and Integrity level of the current user (dave)
```powershell
whoami /groups

GROUP INFORMATION
-----------------
Group Name                           Type             SID                                            Attributes                                        
==================================== ================ ============================================== ==================================================
Everyone                             Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
CLIENTWK220\helpdesk                 Alias            S-1-5-21-2309961351-4093026482-2223492918-1008 Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users         Alias            S-1-5-32-555                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\BATCH                   Well-known group S-1-5-3                                        Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account           Well-known group S-1-5-113                                      Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288 
```
	- Note he's part of the helpdesk and RDP groups
		- Helpdesk staff often have additional permissions and access compared to standard users.

#### Info about current user
```powershell
# May need to be in a cmd prompt
C:\Users\student>net user student  
  
User name                    student  
Full Name  
Comment  
User's comment  
Country/region code          000 (System Default)  
Account active               Yes  
Account expires              Never  
  
Password last set            3/31/2018 10:37:35 AM  
Password expires             Never  
Password changeable          3/31/2018 10:37:35 AM  
Password required            No  
User may change password     Yes  
  
Workstations allowed         All  
Logon script  
User profile  
Home directory  
Last logon                   11/8/2019 12:56:15 PM  
  
Logon hours allowed          All  
  
Local Group Memberships      *Remote Desktop Users *Users  
Global Group memberships     *None  
The command completed successfully.
```

#### Existing users and groups
```powershell
# Enumerate existing users on the machine
# Can also use `net user` within a cmd prompt

PS C:\Users\dave> Get-LocalUser
	Name               Enabled Description                                                                                 
	----               ------- -----------                                                                                 
	Administrator      False   Built-in account for administering the computer/domain                                      
	BackupAdmin        True                                                                                                
	dave               True    dave                                                                                        
	daveadmin          True                                                                                                
	DefaultAccount     False   A user account managed by the system.                                                       
	Guest              False   Built-in account for guest access to the computer/domain                                    
	offsec             True                                                                                                
	steve              True                                                                                                
	WDAGUtilityAccount False   A user account managed and used by the system for Windows Defender Application Guard
```
	- Shows built-in Admin & Guest accounts are disabled
	- offsec & steve are two additional regular users
	- daveadmin and BackupAdmin are two (likely) privileged accounts
		- Admins typically have two users - regular for day-to-day stuff & admin for privileged operations

``` powershell
# Enumerate existing groups on the machine
# If using cmd prompt: net localgroup
PS C:\Users\dave> Get-LocalGroup 
	Name                                Description                                                                        
	----                                -----------                                                                        
	adminteam                           Members of this group are admins to all workstations on the second floor           
	BackupUsers                                                                                                            
	helpdesk                                                                                                               
	...
	Administrators                      Administrators have complete and unrestricted access to the computer/domain        
	...
	Remote Desktop Users                Members in this group are granted the right to logon remotely
	Remote Management Users             Members of this group can access WMI resources over management protocols (such a...                     
	...
```
	- Displays non-standard groups: adminteam, BackupUsers, helpdesk
	- adminteam may be of interest - has its own description (admins to all of 2nd floor)- though we don't know floor structure
	- Backup solutions (BackupAdmin user and BackupUsers group) often have extensive permissions to perform their operations on the file system, making it & the adminteam group potentially valuable targets.

Built in groups that should be analyzed:
- _Administrators_
- _Backup Operators_
	- Can backup and restore all files on a computer, even those files they don't have permissions for (not to be confused w/ non-standard BackupUsers group here)
- _Remote Desktop Users_
	- Can access a system with RDP
- _Remote Management Users_
	- Can access a system with [WinRM](Tools.md#WinRM)

```powershell
# Enumerate through groups' members
PS C:\Users\dave> Get-LocalGroupMember adminteam
	ObjectClass Name                  PrincipalSource
	----------- ----                  ---------------
	User        CLIENTWK220\daveadmin Local

PS C:\Users\dave> Get-LocalGroupMember Administrators
	ObjectClass Name                      PrincipalSource
	----------- ----                      ---------------
	User        CLIENTWK220\Administrator Local          
	User        CLIENTWK220\BackupAdmin   Local          
	User        CLIENTWK220\daveadmin     Local          
	User        CLIENTWK220\offsec        Local

PS C:\Users\dave> Get-LocalGroupMember "Remote Desktop Users"
	ObjectClass Name              PrincipalSource
	----------- ----              ---------------
	User        CLIENTWK220\dave  Local          
	User        CLIENTWK220\steve Local
```
	- Only daveadmin is a member of adminteam (& therefore has Admin privileges on all workstations on 2nd floor)
	- adminteam isn't a member of the Admin group
	- daveadmin and BackupAdmin are local Admins
	- dave and steve have RDP abilities

#### Operating system, version and architecture
```powershell
# Get info on system
PS C:\Users\dave> systeminfo
	Host Name:                 CLIENTWK220
	OS Name:                   Microsoft Windows 11 Pro
	OS Version:                10.0.22000 N/A Build 22000
	...
	System Type:               x64-based PC
```
	- Our shell runs on a Win 11 Pro 64-bit system
	- Build 22000 is the version _21H2_ of Windows 11

Can use `systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type" ` to filter down to that information
	- **systeminfo** - Gathers OS & architecture info
	- **findstr** - Similar to **grep**
		- **/B** - Match patterns at beginning of a line
		- **/C** - Specify a specific search string

#### Network information
- Goal in this step is to identify all network interfaces, routes, and active network connections.
- Based on this info, may ID new services or even access to other networks.
	- May not directly lead us to elevated privileges, but they are vital to understand the machine's purpose and to obtain vectors to other systems and networks.
```powershell
# Enumerate network info
PS C:\Users\dave> ipconfig /all
	Windows IP Configuration
	
	   Host Name . . . . . . . . . . . . : clientwk220
	   Primary Dns Suffix  . . . . . . . : 
	   Node Type . . . . . . . . . . . . : Hybrid
	   IP Routing Enabled. . . . . . . . : No
	   WINS Proxy Enabled. . . . . . . . : No
	
	Ethernet adapter Ethernet0:
	
	   Connection-specific DNS Suffix  . : 
	   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter
	   Physical Address. . . . . . . . . : 00-50-56-BF-52-14
	   DHCP Enabled. . . . . . . . . . . : No
	   Autoconfiguration Enabled . . . . : Yes
	   Link-local IPv6 Address . . . . . : fe80::1405:9da5:a2ef:76a0%6(Preferred) 
	   IPv4 Address. . . . . . . . . . . : 192.168.179.220(Preferred) 
	   Subnet Mask . . . . . . . . . . . : 255.255.255.0
	   Default Gateway . . . . . . . . . : 192.168.179.254
	   DHCPv6 IAID . . . . . . . . . . . : 234901590
	   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2D-97-3E-74-00-50-56-BF-BA-AD
	   DNS Servers . . . . . . . . . . . : 192.168.179.254
	   NetBIOS over Tcpip. . . . . . . . : Enabled
```
	- System has a manually set static IP & doesn't use DHCP
	- Info also contains MAC address, subnet mask, gateway, and DNS server
		- Useful for lateral movement

```powershell
# Display routing table - possible attack vectors to other systems or networks
PS C:\Users\dave>route print
	===========================================================================
	Interface List
	  6...00 50 56 bf 7b 8e ......vmxnet3 Ethernet Adapter
	  1...........................Software Loopback Interface 1
	===========================================================================
	
	IPv4 Route Table
	===========================================================================
	Active Routes:
	Network Destination        Netmask          Gateway       Interface  Metric
	          0.0.0.0          0.0.0.0  192.168.233.254  192.168.233.220     16
	        127.0.0.0        255.0.0.0         On-link         127.0.0.1    331
	        127.0.0.1  255.255.255.255         On-link         127.0.0.1    331
	  127.255.255.255  255.255.255.255         On-link         127.0.0.1    331
	    192.168.233.0    255.255.255.0         On-link   192.168.233.220    271
	  192.168.233.220  255.255.255.255         On-link   192.168.233.220    271
	  192.168.233.255  255.255.255.255         On-link   192.168.233.220    271
	        224.0.0.0        240.0.0.0         On-link         127.0.0.1    331
	        224.0.0.0        240.0.0.0         On-link   192.168.233.220    271
	  255.255.255.255  255.255.255.255         On-link         127.0.0.1    331
	  255.255.255.255  255.255.255.255         On-link   192.168.233.220    271
	===========================================================================
	Persistent Routes:
	  Network Address          Netmask  Gateway Address  Metric
	          0.0.0.0          0.0.0.0  192.168.233.254       1
	===========================================================================
	
	IPv6 Route Table
	===========================================================================
	Active Routes:
	 If Metric Network Destination      Gateway
	  1    331 ::1/128                  On-link
	  6    271 fe80::/64                On-link
	  6    271 fe80::3d61:d09c:8464:b785/128
	                                    On-link
	  1    331 ff00::/8                 On-link
	  6    271 ff00::/8                 On-link
	===========================================================================
	Persistent Routes:
	  None
```
	- Sadly no previously unknown networks

```powershell
# Enumerate all active (-a) netconns without name resolution (-n) showing process id (-o)
PS C:\Users\dave> netstat -ano
Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       2668
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       944
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       2668
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       2836
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       632
  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING       3040
  ...
  TCP    192.168.233.220:139    0.0.0.0:0              LISTENING       4
  TCP    192.168.233.220:3389   192.168.119.4:33060    ESTABLISHED     1084
  TCP    192.168.233.220:4444   192.168.45.156:50148   ESTABLISHED     2708
```
	- **-a** - Display all active TCP connections
	- **-n** - Display address & port number in numerical form
	- **-o** - Display owner PID of each connProvided a list of all the listening ports & included information about established connections that could reveal other users connected to this machine
	- 80 & 443 listening suggest website
	- 3306 points to a MySQL server
	- Established connection via RDP means another user is connected to the system
		- Once privs are escalated, can attempt to dump creds


#### Installed applications
```powershell
# Enumerate 36-bit applications
PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
	displayname                                                       
	-----------
	KeePass Password Safe 2.51.1                                      
	Microsoft Edge                                                    
	Microsoft Edge Update                                             
	Microsoft Edge WebView2 Runtime                                   
	
	Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.28.29913
	Microsoft Visual C++ 2019 X86 Additional Runtime - 14.28.29913    
	Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.28.29913       
	Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.28.29913

# Enumerate 64-bit applications
PS C:\Users\dave> Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
	DisplayName                                                   
	-----------                                                   
	7-Zip 21.07 (x64)                                             
	   
	XAMPP                                                         
	VMware Tools                                                  
	Microsoft Visual C++ 2019 X64 Additional Runtime - 14.28.29913
	Microsoft Update Health Tools                                 
	Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.28.29913
```
	- Shows that KeePass, 7-Zip, and XAMPP are installed
		- Can search for public exploits after system enumeration
		- Getting master password for KeePass could net us more passwords for other logins
	- Listing may not be complete, ALWAYS check C:\Program Files and Downloads folders


#### Running processes
```powershell
# Can also use tasklist /SVC from within a cmd prompt
	# /SVC - Return processes mapped to a specific Windows service.
		# NOTE: Doesn't list processes run by privileged users. Reqs higher perms

PS C:\Users\dave> Get-Process
Get-Process

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName                                                  
-------  ------    -----      -----     ------     --  -- -----------                                                  
     53      13      536       1176       0.03   2708   0 access                                                       
    ...                                                  
    183      29     9528      19788              2668   0 httpd                                                        
    481      49    16568      23068              3828   0 httpd                                                        
    ...                                                      
    176      16   210496      28696              2836   0 mysqld                                                       
    742      27    73940      13536       0.48   6092   0 powershell                                                   
    ...                                                     
    215      17     5596      17128               412   0 xampp-control
```
	- Our bind shell 'access' ID 2708
	- Powershell session used to enumerate ID 6092
	- MySQL daemon ID 2836
	- Apache's httpd ID 3828
	- As 'xampp-control' ID 412 is running, shows Apache and MySQL were started through XAMPP


#### Scheduled Tasks

```powershell
PS C:\Users\steve> schtasks /query /fo LIST /v
	...
	Folder: \Microsoft
	HostName:                             CLIENTWK220
	TaskName:                             \Microsoft\CacheCleanup      #<--NOTE
	Next Run Time:                        4/26/2024 9:50:21 AM         #<--NOTE
	Status:                               Ready
	Logon Mode:                           Interactive/Background
	Last Run Time:                        4/26/2024 9:49:22 AM
	Last Result:                          0
	Author:                               CLIENTWK220\daveadmin        #<--NOTE
	Task To Run:                          C:\Users\steve\Pictures\BackendCacheCleanup.exe      #<--NOTE
	Start In:                             C:\Users\steve\Pictures
	Comment:                              N/A
	Scheduled Task State:                 Enabled
	Idle Time:                            Disabled
	Power Management:                     Stop On Battery Mode
	Run As User:                          daveadmin
	Delete Task If Not Rescheduled:       Disabled
	Stop Task If Runs X Hours and X Mins: Disabled
	Schedule:                             Scheduling data is not available in this format.
	Schedule Type:                        One Time Only, Minute
	Start Time:                           7:37:21 AM
	Start Date:                           7/4/2022
	End Date:                             N/A
	Days:                                 N/A
	Months:                               N/A
	Repeat: Every:                        0 Hour(s), 1 Minute(s)
	Repeat: Until: Time:                  None
	Repeat: Until: Duration:              Disabled
	Repeat: Stop If Still Running:        Disabled
	...
```


# "Passwords on a Sticky Note"

Sensitive information may be stored in meeting notes, configuration files, or onboarding documents.

Given what was found during previous enumeration (KeePass & XAMPP), search for password manager databases and configuration files of these apps.
- KeePass stores databases in *.kdbx* files
- XAMPP stores config files in *.txt* and *.ini* files
```powershell
# Find KeePass databases
PS C:\Users\dave> Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
# No results shows that no KeePass databases can be found

# Search for sensitive info in the XAMPP config files
PS C:\Users\dave> Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
	...
	    Directory: C:\xampp\mysql\bin
	Mode                 LastWriteTime         Length Name                                                                 
	----                 -------------         ------ ----                                                                 
	-a----         6/22/2022  10:52 AM           5824 my.ini   #<-- Config file for MySQL
	...
	
	    Directory: C:\xampp
	Mode                 LastWriteTime         Length Name                                                                 
	----                 -------------         ------ ----                                                                 
	-a----         3/13/2017   4:04 AM            824 passwords.txt                                                        
	...

# Read password file
PS C:\Users\dave> gc c:\xampp\passwords.txt
	### XAMPP Default Passwords ###
	
	1) MySQL (phpMyAdmin):
	
	   User: root
	   Password:
	   (means no password!)
	
	2) FileZilla FTP:
	
	   [ You have to create a new user on the FileZilla Interface ] 
	
	3) Mercury (not in the USB & lite version): 
	
	   Postmaster: Postmaster (postmaster@localhost)
	   Administrator: Admin (admin@localhost)
	
	   User: newuser  
	   Password: wampp 
	
	4) WEBDAV: 
	
	   User: xampp-dav-unsecure
	   Password: ppmax2011
	   Attention: WEBDAV is not active since XAMPP Version 1.7.4.
	   For activation please comment out the httpd-dav.conf and
	   following modules in the httpd.conf
	   
	   LoadModule dav_module modules/mod_dav.so
	   LoadModule dav_fs_module modules/mod_dav_fs.so  
	   
	   Please do not forget to refresh the WEBDAV authentification (users and passwords).

# Read my.ini
PS C:\Users\dave> gc c:\xampp\mysql\bin\my.ini
	gc : Access to the path 'C:\xampp\mysql\bin\my.ini' is denied.
```
	- Unfortunately, passwords.txt only contains default password settings & reading the my.ini file is denied

- As that was a bust, search for files in the user's directory
```powershell
PS C:\Users\dave> Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
	Directory: C:\users\dave\Desktop
	
	Mode                 LastWriteTime         Length Name                                                                 
	----                 -------------         ------ ----                                                                 
	-a----         6/16/2022  11:28 AM            339 asdf.txt

PS C:\Users\dave> gc c:\users\dave\Desktop\asdf.txt
	notes from meeting:
	
	- Contractors won't deliver the web app on time
	- Login will be done via local user credentials
	- I need to install XAMPP and a password manager on my machine 
	- When beta app is deployed on my local pc: 
	Steve (the guy with long shirt) gives us his password for testing
	password is: securityIsNotAnOption++++++
```
	- Steve's password is securityIsNotAnOption++++++

- Before leveraging the password, check what group Steve's in
```powershell
PS C:\Users\dave> net user steve
	...
	Password last set            6/16/2022 12:08:00 PM
	Password expires             Never
	Password changeable          6/16/2022 12:08:00 PM
	Password required            Yes
	User may change password     Yes
	
	Workstations allowed         All
	...
	Local Group Memberships      *helpdesk             *Remote Desktop Users 
	                             *Remote Management Use*Users                
	Global Group memberships     *None                 
	The command completed successfully.
```
	- steve isn't an Admin, but he does have RDP access

- RDP'ing in as `steve` starts the whole Discovery process all over again
	- While we're on the same endpoint, we don't need to redo process, network, etc enumeration, we will need to look through the user's info
- Given we couldn't access the *my.ini* file with `dave`, we should now test with `steve`
```powershell
PS C:\Users\steve> gc C:\xampp\mysql\bin\my.ini
	# The following options will be passed to all MySQL clients
	# backupadmin Windows password for backup job
	[client]
	password       = admin123admin123!
	port=3306
```
	- Not only did we find the password, but we've discovered that it's the password for *backupadmin* user

- Find out what groups `backupadmin` user is a part of
```powershell
PS C:\Users\steve> net user backupadmin
	...
	Local Group Memberships      *Administrators    *BackupUsers    *Users
	Global Group memberships     *None
```
	- *backupadmin* is part of Admin group, but not RDP or Remote Management Users

- As we have a GUI, we can use `runAs` to open up a command prompt as the `backupadmin` user
```powershell
runAs /user:backupadmin cmd
	Enter the password for backupadmin: <Enter admin123admin123!>
	Attempting to start cmd as user "CLIENTWK220\backupadmin" ...

	C:\Windows\system32>whoami
		clientwk220\backupadmin
```

# PowerShell Info & History

Because of the growing threat of cyber attacks, more defensive measures were developed and implemented for clients and servers alike.
One of these measures is to collect and record more data on systems about executed commands and operations, which allows the IT staff to review and respond accordingly to threats.

You'll often find PowerShell logging mechanisms enabled on Windows clients and servers
- PowerShell Transcription
- PowerShell Script Block Logging

### PS Transcription
- aka Over-The-Shoulder-Transcription
- When enabled, the logged information is equal to what a person would obtain from looking over the shoulder of a user entering commands

Information is stored in *transcript files*, often saved in:
- Users' home directories
- Central directory for all users
- Network share collecting files from all configured machines

### PS Script Block Logging
- Records commands and blocks of script code as events while executing
- An event also contains the original representation of encoded code or commands.

### Demonstration
- Assume that the files containing sensitive information from the previous section don't exist.
- Before checking if *PS Transcription* or *Script Block Logging* is enabled, check the history of the user
```powershell
Get-History
```

- There may not be any history recorded
	- Most Admins erase it
```powershell
Clear-History
```
- Only works with clearing out PS's own history
- Does not clear out history recorded by `PSReadline`

```powershell
# PSReadline
(Get-PSReadlineOption).HistorySavePath
```
	- This syntax allows us to get only one option from all available options of the module
- Module used for line-editing and command history functionality.
- Included with PowerShell v5, v5.1, and v7

```powershell
PS C:\Users\dave> (Get-PSReadlineOption).HistorySavePath
		C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

PS C:\Users\dave> Get-Content C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
	...
	$PSVersionTable
	Register-SecretVault -Name pwmanager -ModuleName SecretManagement.keepass -VaultParameters $VaultParams
	Set-Secret -Name "Server02 Admin PW" -Secret "paperEarMonitor33@" -Vault pwmanager
	cd C:\
	ls
	cd C:\xampp
	ls
	type passwords.txt
	Clear-History
	Start-Transcript -Path "C:\Users\Public\Transcripts\transcript01.txt"
	Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred
	exit
	Stop-Transcript
```
	- C:\xampp\passwords.txt contains default passwords
	- *Register-SecretVault* with the module *SecretManagement.keepass* implies that the user created a new password manager database for KeePass
	- *Set-Secret* was used to create a secret, or entry, in the password manager with the name *Server02 Admin PW* and password *paperEarMonitor33@*
		- Probably creds for another system, but may be reused, so attempt to leverage the pw for any user, service, or login on CLIENTWK220
	- *Start-Transcript* starts a PS transcript (& shows the file's path)
	- *Enter-PSSession* (w/ hostname of the local machine(-ComputerName) and a *PSCredential* object- *$cred* w/ the uname and pw for *-Credential*
		- The commands to create the PSCredential object aren't included in the history file; we don't know which user and pw were used


**Note: Since the PowerShell Transcription started before Enter-PSSession was entered, it may contain the plain-text credential information used to create the PSCredential object stored in the variable _$cred_.**

```powershell
PS C:\Users\dave> type C:\Users\Public\Transcripts\transcript01.txt
	**********************
	Windows PowerShell transcript start
	Start time: 20220623081143
	Username: CLIENTWK220\dave
	RunAs User: CLIENTWK220\dave
	Configuration Name: 
	Machine: CLIENTWK220 (Microsoft Windows NT 10.0.22000.0)
	Host Application: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process ID: 10336
	PSVersion: 5.1.22000.282
	PSEdition: Desktop
	PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.22000.282
	BuildVersion: 10.0.22000.282
	CLRVersion: 4.0.30319.42000
	WSManStackVersion: 3.0
	PSRemotingProtocolVersion: 2.3
	SerializationVersion: 1.1.0.1
	**********************
	Transcript started, output file is C:\Users\Public\Transcripts\transcript01.txt
	PS C:\Users\dave> $password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force
	PS C:\Users\dave> $cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)
	PS C:\Users\dave> Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred
	PS C:\Users\dave> Stop-Transcript
	**********************
	Windows PowerShell transcript end
	End time: 20220623081221
	**********************
```
	- Contains commands to create the variable *$cred*


>- To create the previously discussed *PSCredential* object
	- First create a *SecureString* to store the pw
	- Create the *PSCredential* object with the uname and the stored pw
	- Resulting variable, containing the object, can be used as argument for *-Credential* in commands such as *Enter-PSSession*

##### Start a PowerShell remoting session via WinRM on CLIENTWK220 as the user *daveadmin*
```powershell
PS C:\Users\dave> $password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force
PS C:\Users\dave> $cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)
PS C:\Users\dave> Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred

[CLIENTWK220]: PS C:\Users\daveadmin\Documents> whoami
	clientwk220\daveadmin
```

> Starting a remote session via WinRM in a bind shell can cause issues (like no responses from commands)

##### Connect via [*evil-winrm*](Tools.md#evil-winrm)
```bash
evil-winrm -i 192.168.50.220 -u daveadmin -p "qwertqwertqwert123\!\!"
```


# Automated Enumeration

>Automated tools can be blocked by AV solutions. If this is the case, we can apply techniques learned in the Module "Antivirus Evasion", try other tools such as [Seatbelt](Tools.md#Seatbelt) and [JAWS](Tools.md#jaws) or do the enumeration manually.

### [winpeas](Tools.md#winPEAS)
`sudo apt update && sudo apt install peass`

- Start a python server in `/usr/share/peass/winpeas`
- Once connected to windows machine, connect to python server and download *winpeasx64.exe*
```powershell
PS C:\Users\dave> iwr -uri http://192.168.118.2/winPEASx64.exe -Outfile winpeasx64.exe

.\winpeasex64.exe
```

![](winpeas.png)

> On the other hand, the tool incorrectly identified the target as Windows 10 and missed the meeting note, PowerShell history, and transcript file, which we used to elevate our privileges in the previous sections. However, because of the missing findings we should not abstain from using automated tools, but merely understand their limits.


Can also use [Seatbelt](Tools.md#Seatbelt).  Need to download [compiled binary](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries) and host on python server for download to victim computer.

For everything, run `Seatbelt.exe -group=all`


# Removed

## Enumerate Firewall Status & Rules

Can be useful during privesc.  
- If a network service is not remotely accessible because it is blocked by the firewall, it is generally accessible locally via the loopback interface.  
- If we can interact with these services locally, we may be able to exploit them to escalate our privileges on the local system.  
- In addition, we can gather information about inbound and outbound port filtering during this phase to facilitate port forwarding and tunneling when it's time to pivot to an internal network.  

```powershell
C:\Users\student>netsh advfirewall show currentprofile  
  
Public Profile Settings:  
---------------------------------------------------------------  
State                          ON  
Firewall Policy                BlockInbound,AllowOutbound  
LocalFirewallRules             N/A (GPO-store only)  
LocalConSecRules               N/A (GPO-store only)  
InboundUserNotification        Enable  
RemoteManagement               Disable  
UnicastResponseToMulticast     Enable  
  
Logging:  
LogAllowedConnections          Disable  
LogDroppedConnections          Disable  
FileName                       %systemroot%\system32\LogFiles\Firewall\pfirewall.log  
MaxFileSize                    4096  
  
Ok.
```

##### List FW rules
```powershell
C:\Users\student>netsh advfirewall firewall show rule name=all | more  
  
Rule Name:         @{Microsoft.Windows.Photos_2018.18022.15810.1000_x86__8wekyb3d8bbw  
---------------------------------------------------  
Enabled:           Yes  
Direction:         In  
Profiles:          Domain,Private,Public  
Grouping:          Microsoft Photos  
LocalIP:           Any  
RemoteIP:          Any  
Protocol:          Any  
Edge traversal:    Yes  
Action:            Allow  
  
Rule Name:         @{Microsoft.Windows.Photos_2018.18022.15810.1000_x86__8wekyb3d8bbw  
----------------------------------------------------------------------  
Enabled:           Yes  
Direction:         Out  
Profiles:          Domain,Private,Public  
Grouping:          Microsoft Photos  
LocalIP:           Any  
RemoteIP:          Any  
Protocol:          Any  
Edge traversal:    No  
Action:            Allow  
  
Rule Name:         @{Microsoft.XboxIdentityProvider_12.39.13003.1000_x86__8wekyb3d8bb  
----------------------------------------------------------------------  
...
```
	*Def pipe to **more** as this can produce a LOT of output. <space> to display next page.  
  
According to the two firewall rules listed above, the Microsoft Photos app is allowed to establish both inbound and outbound conns to/ from any IP address using any protocol.  

Keep inmind that not all firewall rules are useful but some configurations may help us expand our attack surface.

## Enumerate Scheduled Tasks

Systems that act as servers often periodically execute various automated, scheduled tasks.

The scheduling systems on these servers often have somewhat confusing syntax, which is used to execute user-created executable files or scripts.  

When these systems are misconfigured, or the user-created files are left with insecure perms, we can modify these files that will be executed by the scheduling system at a high privilege level.

```powershell
c:\Users\student>schtasks /query /fo LIST /v | more  
  
Folder: \  
INFO: There are no scheduled tasks presently available at your access level.  
  
Folder: \Microsoft  
INFO: There are no scheduled tasks presently available at your access level.  
  
Folder: \Microsoft\Office  
HostName:                             CLIENT251  
TaskName:                             \Microsoft\Office\Office 15 Subscription Heartbeat  
Next Run Time:                        11/12/2019 3:18:24 AM  
Status:                               Ready  
Logon Mode:                           Interactive/Background  
Last Run Time:                        11/11/2019 3:49:25 AM  
Last Result:                          0  
Author:                               Microsoft Office  
Task To Run:                          %ProgramFiles%\Common Files\Microsoft Shared\Office16\OLicenseHeartbeat.exe  
...  
Schedule Type:                        Daily  
Start Time:                           12:00:00 AM  
Start Date:                           1/1/2010  
End Date:                             N/A  
Days:                                 Every 1 day(s)  
...
```
	Again, pipe to **more**
.
	- **/query** - Displays tasks  
	- **/FO LIST** - Sets output format to a simple list  
	-  **/V** - Verbose output  
  
Output includes a lot of useful information such as the task to run, the next time it is due to run, the last time it ran, and details about how often it will run.

## Enumerate Installed Apps & Patches

Useful for finding matching exploits to help elevate privileges. Uses [wmic](OS%20Commands.md#wmic)

```powershell
c:\Users\student>wmic product get name, version, vendor  
Name                                       Vendor                      Version  
Microsoft OneNote MUI (English) 2016       Microsoft Corporation       16.0.4266.1001  
Microsoft Office OSM MUI (English) 2016    Microsoft Corporation       16.0.4266.1001  
Microsoft Office Standard 2016             Microsoft Corporation       16.0.4266.1001  
Microsoft Office OSM UX MUI (English) 2016 Microsoft Corporation       16.0.4266.1001  
Microsoft Office Shared Setup Metadata MUI Microsoft Corporation       16.0.4266.1001  
Microsoft Excel MUI (English) 2016         Microsoft Corporation       16.0.4266.1001  
Microsoft PowerPoint MUI (English) 2016    Microsoft Corporation       16.0.4266.1001  
Microsoft Publisher MUI (English) 2016     Microsoft Corporation       16.0.4266.1001  
Microsoft Outlook MUI (English) 2016       Microsoft Corporation       16.0.4266.1001  
Microsoft Groove MUI (English) 2016        Microsoft Corporation       16.0.4266.1001  
Microsoft Word MUI (English) 2016          Microsoft Corporation       16.0.4266.1001  
....
```


Can also be used to list system-wide updates by querying the [Win32_QuickFixEngineering(qfe)](https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-quickfixengineering) WMI class:  
```powershell
c:\Users\student>wmic qfe get Caption, Description, HotFixID, InstalledOn  
Caption                                     Description      HotFixID   InstalledOn  
                                            Update           KB2693643  4/7/2018  
http://support.microsoft.com/?kbid=4088785  Security Update  KB4088785  3/31/2018  
http://support.microsoft.com/?kbid=4090914  Update           KB4090914  3/31/2018  
http://support.microsoft.com/?kbid=4088776  Security Update  KB4088776  3/31/2018
```

Provide us with a precise indication of the security posture of the target Windows operating system. 
According to this output, this system has not been updated recently, which might make it easier to exploit.

## Enumerate RW Files & Directories

Files with insufficient access restrictions can create a vulnerability that can grant an attacker elevated privileges.
This most often happens when an attacker can modify scripts or binary files that are executed under the context of a privileged account.
In addition, sensitive files that are readable by an unprivileged user may contain important information such as hardcoded credentials for a database or a service account. 

Can use **AccessChk** from SysInternals to automate the search on Win:  
```powershell
c:\Tools\privilege_escalation\SysinternalsSuite>accesschk.exe -uws "Everyone" "C:\Program Files"  
  
Accesschk v6.12 - Reports effective permissions for securable objects  
Copyright (C) 2006-2017 Mark Russinovich  
Sysinternals - www.sysinternals.com  
  
RW C:\Program Files\TestApplication\testapp.exe
```
.  
	- **-u** - Suppress errors  
	- **-w** - Search for write access perms  
	- **-s** - Recursive search  
  
AccessChk successfully identified one executablefile that is world-writable.  
	If this file were to be executed by a privileged user or a service account,  
we could attempt to overwrite it with a malicious file of our choice, such as a reverse shell, in order to elevate our privileges.  
  
We can also accomplish this in powershell:
```powershell
PS C:\Tools\privilege_escalation\SysinternalsSuite>Get-ChildItem "C:\Program Files" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}  
  
  
    Directory: C:\Program Files\TestApplication  
  
  
Path        Owner                  Access  
----        -----                  ------  
testapp.exe BUILTIN\Administrators Everyone Allow  Modify, Synchronize....
```
.
	- **Get-ACL** - Retrieves all permissions for a given file or directory. However,since Get-ACL cannot be run recursively, we are also using:  
	- **Get-ChildItem** - Enumerate everything under the Program Files directory. This will effectively retrieve every single object in our target directory along with all associated accesspermissions  
	- **AccessToString** & **-match** - Narrows down the results to the specific access properties we're looking for. In our case, we are searching for any object can be modified (Modify) by members of the Everyone group.


## Enumerate Unmounted Disks

List drives that are currently mounted & drives physically connected but not mounted & check mount permissions.

```powershell
c:\Users\student>mountvol  
Creates, deletes, or lists a volume mount point.  
...  
Possible values for VolumeName along with current mount points are:  
  
    \\?\Volume{25721a7f-0000-0000-0000-100000000000}\  
        *** NO MOUNT POINTS ***  
  
    \\?\Volume{25721a7f-0000-0000-0000-602200000000}\  
        C:\  
  
    \\?\Volume{78fa00a6-3519-11e8-a4dc-806e6f6e6963}\  
        D:\

```
	System has two mount points that map to the C: and D: drives respectively.  
	Also a volume with the globally unique identifier (GUID) 25721a7f-0000-0000-0000-100000000000, which has no mount point.  
		This could be interesting and we might want to investigate further.

## Enumerate Device Drivers & Kernel Modules
  
Similar to enumerating through apps & their patches, this is useful for finding exploits online for privesc.

```powershell
PS C:\Users\student> driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object ‘Display Name’, ‘Start Mode’, Path  
  
Display Name                         Start Mode Path  
------------                         ---------- ----  
1394 OHCI Compliant Host Controller  Manual     C:\Windows\system32\drivers\1394ohci.s  
3ware                                Manual     C:\Windows\system32\drivers\3ware.sys  
Microsoft ACPI Driver                Boot       C:\Windows\system32\drivers\ACPI.sys  
ACPI Devices driver                  Manual     C:\Windows\system32\drivers\AcpiDev.sy  
Microsoft ACPIEx Driver              Boot       C:\Windows\system32\Drivers\acpiex.sys  
ACPI Processor Aggregator Driver     Manual     C:\Windows\system32\drivers\acpipagr.s  
ACPI Power Meter Driver              Manual     C:\Windows\system32\drivers\acpipmi.sy  
ACPI Wake Alarm Driver               Manual     C:\Windows\system32\drivers\acpitime.s  
ADP80XX                              Manual     C:\Windows\system32\drivers\ADP80XX.SY
```
.
	- **/v** - Verbose output  
	- **/fo csv** - Format output as CSV  
	- **Select-Object** - Select specific object properties or sets of objects  
  
  
This only lists drivers, so we'll still need the versions:  
```powershell

PS C:\Users\student> Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMware*"}  
  
DeviceName               DriverVersion Manufacturer  
----------               ------------- ------------  
VMware VMCI Host Device  9.8.6.0       VMware, Inc.  
VMware PVSCSI Controller 1.3.10.0      VMware, Inc.  
VMware SVGA 3D           8.16.1.24     VMware, Inc.  
VMware VMCI Bus Device   9.8.6.0       VMware, Inc.  
VMware Pointing Device   12.5.7.0      VMware, Inc.
```
.
	- **Get-WmiObject** - Get the _Win32_PnPSignedDriver_ WMI instance  
		- Provides digital signature information about drivers.  
	- **Select-Object** - Enumerate specific properties  
	- **Where-Object** - Target drivers based on their name  


## Enumerate AutoElevate Binaries

Interesting OS-specific"shortcuts" to privilege escalation....    
Should check the status of the _AlwaysInstallElevated_ registry setting. 
If this key is enabled (set to 1) in either HKEY_CURRENT_USER or HKEY_LOCAL_MACHINE, any user can run Windows Installer packages with elevated privileges. 

```powershell
c:\Users\student>reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer  
  
HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer  
    AlwaysInstallElevated    REG_DWORD    0x1  
  
c:\Users\student>reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer  
  
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer  
    AlwaysInstallElevated    REG_DWORD    0x1
```
	If this setting is enabled, we could craft an _MSI_ file and run it to elevate our privileges.


## Automated Enumeration

Various scripts can be used to automate target enumeration.  
  
Although these tools perform many automated checks, bear in mind that every system is different, and unique one-off system changes will often be missed by these types of tools.  
For this reason, it's important to watch out for unique configurations that can only be caught by manual inspection.

[windows-privesc-check](Windows-Privesc-Check.md)  
  
List info about user groups on the system:  
```powershell
c:\Tools\privilege_escalation\windows-privesc-check-master>windows-privesc-check2.exe --dump -G  
  
windows-privesc-check v2.0 (http://pentestmonkey.net/windows-privesc-check)  
  
[i] TSUserEnabled registry value is 0. Excluding TERMINAL SERVER USER  
  
Considering these users to be trusted:  
* BUILTIN\Power Users  
* BUILTIN\Administrators  
* NT SERVICE\TrustedInstaller  
* NT AUTHORITY\SYSTEM  
  
[i] Running as current user.  No logon creds supplied (-u, -D, -p).  
...  
============ Starting Audit at 2019-09-22 12:45:56 ============  
  
[+] Running: dump_misc_checks  
[+] Host is not in domain  
 [+] Checks completed  
  
[+] Running: dump_groups  
[+] Dumping group list:  
BUILTIN\Administrators has member: CLIENT251\Administrator  
BUILTIN\Administrators has member: CLIENT251\admin  
BUILTIN\Administrators has member: [unknown]\S-1-5-21-2715734670-1758985447-1278008508  
BUILTIN\Administrators has member: [unknown]\S-1-5-21-2715734670-1758985447-1278008508  
BUILTIN\Guests has member: CLIENT251\Guest  
BUILTIN\IIS_IUSRS has member: NT AUTHORITY\IUSR  
BUILTIN\Remote Desktop Users has member: CLIENT251\student  
BUILTIN\Users has member: NT AUTHORITY\INTERACTIVE  
BUILTIN\Users has member: NT AUTHORITY\Authenticated Users  
BUILTIN\Users has member: CLIENT251\student  
BUILTIN\Users has member: [unknown]\S-1-5-21-2715734670-1758985447-1278008508-513  
[+] Checks completed
```
