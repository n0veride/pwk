## DNS Enumeration

[Domain Name System](DNS.md) - Distributed database responsible for translating domain names into IP addresses. (port 53)

Each domain uses different types of [DNS Records](DNS%20-%20Records.md)
#### Record Types

| Record Type | Description |
| ---- | ---- |
| A Record | Address Record - Points a domain or subdomain to an IP address |
| CNAME | Canonical Name - Points one domain or subdomain to another domain name, allowing you to update 1 A Record each time you make a change, regardless of how many Host Records need to resolve to that IP |
| MX Entry | Mail Exchanger - Directs email to a particular mail server |
| TXT Record | Text Record - OG used for human-readable text, but dynamic and can be used for several purposes. Value is what the record 'points to' - doesn't direct traffic, but provides needed info to outside sources |
| SRV Record | Service Record - Points one domain to another domain name useing a specific destination port (VOIP or IM) |
| AAAA Record | Similar to A Record, but allows you to point the domain to an IPv6 address |
| NS Record | Nameserver Record - Contains the name of the authoritative servers hosting the DNS records for a domain |
| PTR Record | Pointer Record - Used in reverse lookup zones and are used to find the records associated w/ an IP address |
  
### [**host**](Tools.md#host)

Find the IP addresses of a domain. Queries DNS (default A Record; use **-t** switch to change or **-a** to show all)

By Default, **host** queries the A Record
```bash
host www.megacorpone.com
	www.megacorpone.com has address 149.56.244.87
```

Using the *-t* switch to query a specific record
```bash
host -t mx megacorpone.com
	megacorpone.com mail is handled by 10 fb.mail.gandi.net.
	megacorpone.com mail is handled by 20 spool.mail.gandi.net.
	megacorpone.com mail is handled by 50 mail.megacorpone.com.
	megacorpone.com mail is handled by 60 mail2.megacorpone.com.
```
	The MX server with the lowest priority number will be used first to forward mail addressed to the domain

Use the *-a* switch to query all records.


#### DNS Brute Forcing

##### Forward Lookup Brute Force
Using a wordlist that contains common hostnames, we can brute force DNS servers and check their responses for valid hostnames.  
	More wordlists are available as part of the seclists project (**sudo apt install seclists** - /usr/share/seclists)  

```bash
cat list.txt
	www  
	ftp  
	mail  
	owa  
	proxy  
	router
```
  
```bash
for ip in $(cat list.txt); do host $ip.megacorpone.com; done
	www.megacorpone.com has address 149.56.244.87  
	Host ftp.megacorpone.com not found: 3(NXDOMAIN)  
	mail.megacorpone.com has address 51.222.169.212  
	Host owa.megacorpone.com not found: 3(NXDOMAIN)  
	Host proxy.megacorpone.com not found: 3(NXDOMAIN)  
	router.megacorpone.com has address 51.222.169.214
```
	Domains www, mail, and router were discovered.

Both *mail* and *router* are part of the IP range 51.222.169.x allowing us to attempt a reverse lookup brute force.

##### Reverse Lookup Brute Force

If the PTR records are set for a domain, you can scan the approximate IP range with reverse lookups to request the hostname for each IP.  Filter using **grep** 
```bash
for ip in $(seq 200 225); do host 51.222.169.$ip; done | grep megacorpone | grep -v "not found"
	208.169.222.51.in-addr.arpa domain name pointer admin.megacorpone.com.  
	209.169.222.51.in-addr.arpa domain name pointer beta.megacorpone.com.  
	210.169.222.51.in-addr.arpa domain name pointer fs1.megacorpone.com.  
	211.169.222.51.in-addr.arpa domain name pointer intranet.megacorpone.com.  
	212.169.222.51.in-addr.arpa domain name pointer mail.megacorpone.com.  
	213.169.222.51.in-addr.arpa domain name pointer mail2.megacorpone.com.  
	214.169.222.51.in-addr.arpa domain name pointer router.megacorpone.com.  
	215.169.222.51.in-addr.arpa domain name pointer siem.megacorpone.com.  
	216.169.222.51.in-addr.arpa domain name pointer snmp.megacorpone.com.  
	217.169.222.51.in-addr.arpa domain name pointer syslog.megacorpone.com.  
	218.169.222.51.in-addr.arpa domain name pointer support.megacorpone.com.  
	219.169.222.51.in-addr.arpa domain name pointer test.megacorpone.com.  
	220.169.222.51.in-addr.arpa domain name pointer vpn.megacorpone.com.
```


### [dnsrecon](Tools.md#dnsrecon)
DNS enumeration script written in Python.

LIkely most common switches:

| Options | Desc |
| ---- | ---- |
| **-d** | Specify a domain name |
| **-D** | Specify file name containing potential subdomain strings |
| **-t** | Specify type of enumeration to perform |
| **axfr** | zone transfer |
| **brt** | brute force |

Run a standard scan (*-t std*) against a domain (*-d*):
```bash
dnsrecon -d megacorpone.com -t std
	[*] std: Performing General Enumeration against: megacorpone.com...
	[-] DNSSEC is not configured for megacorpone.com
	[*] 	 SOA ns1.megacorpone.com 51.79.37.18
	[*] 	 NS ns1.megacorpone.com 51.79.37.18
	[*] 	 NS ns3.megacorpone.com 66.70.207.180
	[*] 	 NS ns2.megacorpone.com 51.222.39.63
	[*] 	 MX mail.megacorpone.com 51.222.169.212
	[*] 	 MX spool.mail.gandi.net 217.70.178.1
	[*] 	 MX fb.mail.gandi.net 217.70.178.217
	[*] 	 MX fb.mail.gandi.net 217.70.178.216
	[*] 	 MX fb.mail.gandi.net 217.70.178.215
	[*] 	 MX mail2.megacorpone.com 51.222.169.213
	[*] 	 TXT megacorpone.com Try Harder
	[*] 	 TXT megacorpone.com google-site-verification=U7B_b0HNeBtY4qYGQZNsEYXfCJ32hMNV3GtC0wWq5pA
	[*] Enumerating SRV Records
	[+] 0 Records Found
```


We can use the *list.txt* file from the previous [Brute Forcing exercise](6.3%20-%20Active%20Info.md#Forward%20Lookup%20Brute%20Force) to perform a brute force attack with the tool.
```bash
dnsrecon -d megacorpone.com -D ~/list.txt -t brt
	[*] Using the dictionary file: /home/kali/list.txt (provided by user)
	[*] brt: Performing host and subdomain brute force against megacorpone.com...
	[+] 	 A www.megacorpone.com 149.56.244.87
	[+] 	 A mail.megacorpone.com 51.222.169.212
	[+] 	 A router.megacorpone.com 51.222.169.214
	[+] 3 Records Found
```


### [dnsenum](Tools.md#dnsenum)
Multi-threaded script to enumerate information on a domain and to discover non-contiguous IP blocks.

Even a simple scan can reveal a lot:
```bash
dnsenum megacorpone.com
	...
	dnsenum VERSION:1.2.6
	
	-----   megacorpone.com   -----
	...
	
	Brute forcing with /usr/share/dnsenum/dns.txt:
	_______________________________________________
	
	admin.megacorpone.com.                   5        IN    A        51.222.169.208
	beta.megacorpone.com.                    5        IN    A        51.222.169.209
	fs1.megacorpone.com.                     5        IN    A        51.222.169.210
	intranet.megacorpone.com.                5        IN    A        51.222.169.211
	mail.megacorpone.com.                    5        IN    A        51.222.169.212
	mail2.megacorpone.com.                   5        IN    A        51.222.169.213
	ns1.megacorpone.com.                     5        IN    A        51.79.37.18
	ns2.megacorpone.com.                     5        IN    A        51.222.39.63
	ns3.megacorpone.com.                     5        IN    A        66.70.207.180
	router.megacorpone.com.                  5        IN    A        51.222.169.214
	siem.megacorpone.com.                    5        IN    A        51.222.169.215
	snmp.megacorpone.com.                    5        IN    A        51.222.169.216
	syslog.megacorpone.com.                  5        IN    A        51.222.169.217
	test.megacorpone.com.                    5        IN    A        51.222.169.219
	vpn.megacorpone.com.                     5        IN    A        51.222.169.220
	www.megacorpone.com.                     5        IN    A        149.56.244.87
	www2.megacorpone.com.                    5        IN    A        149.56.244.87
	
	
	megacorpone.com class C netranges:
	___________________________________
	
	 51.79.37.0/24
	 51.222.39.0/24
	 51.222.169.0/24
	 66.70.207.0/24
	 149.56.244.0/24
	
	
	Performing reverse lookup on 1280 ip addresses:
	________________________________________________
	
	18.37.79.51.in-addr.arpa.                86400    IN    PTR      ns1.megacorpone.com.
	...
```

### [nslookup](Tools.md#nslookup)

Not technically listed as a LOLBAS, this Win DNS enumuration tool is still heavily used in LotL attacks

Simple A record query:
```powershell
nslookup mail.megacorptwo.com
	DNS request timed out.
	    timeout was 2 seconds.
	Server:  UnKnown
	Address:  192.168.50.151
	
	Name:    mail.megacorptwo.com
	Address:  192.168.50.154
```

Specifically querying the 192.168.50.151 DNS server for a TXT record related to the host info.megacorpone.com
```powershell
nslookup -type=TXT info.megacorptwo.com 192.168.50.151
	Server:  UnKnown
	Address:  192.168.50.151
	
	info.megacorptwo.com    text =
	
	        "greetings from the TXT record body"
```

### Removed from course

#### [Zone Transfers](DNS%20-%20Zone%20Transfers.md)
When misconfigured by admins, anyone can request a copy of the DNS server zone file. The _Zone File_ contains a list of all the DNS names configured for that zone.  
Equivalent to gaining a network layout of a corporation w/ names, addresses, and functionality of their servers.  
Worse misconfiguration is not separating internal DNS namespaces from external DNS namespaces into separate, unrelated zones. Allows for complete map of entire network structure.  
  
Using **-l** option with the [host](Tools.md#host)
```bash
host -l megacorpone.com ns1.megacorpone.com
	Using domain server:  
	Name: ns1.megacorpone.com  
	Address: 51.79.37.18#53  
	Aliases:   
	  
	Host megacorpone.com not found: 2(SERVFAIL)  
	; Transfer failed.
```
	Means it's configured correctly and will not allow zone transfers.
		ns2.megacorpone.com DOES allow zone transfers.
  
#### [dig](Tools.md#dig)
```bash
dig axfr google.com

dig google.com ANY +nostat +nocmd +nocomments
```
 
#### [Sublist3r](Tools.md#Sublist3r)
python tool to enumerate subdomains of websites using OSINT.


## Port Scanning

Using a proper port scanning methodology can significantly improve efficiency while also limiting many of the risks.  
Depending on the scope of the engagement, start by only scanning for ports 80 and 443.  
With a list of possible web servers, run a full port scan against these servers in the background while performing other enumeration.  

Port scanning should be understood as a dynamic process that is unique to each engagement. The results of one scan determine the type and scope of the next scan.

### TCP Port Scanning
The simplest scanning technique is called CONNECT scanning, relies on the [three-way TCP handshake](TCP%20-%203-Way%20Handshake.md) mechanism.
If the handshake completes, the port's considered open.
	Takes longer than SYN scan, but doesn't require root privileges.  
  
[netcat](Tools.md#netcat), while _not_ a port scanner, can be used as one.
  
Ex:  
```bash
nc -nvv -w 1 -z 192.168.50.152 3388-3390
	(UNKNOWN) [192.168.50.152] 3390 (?) : Connection refused
	(UNKNOWN) [192.168.50.152] 3389 (ms-wbt-server) open
	(UNKNOWN) [192.168.50.152] 3388 (?) : Connection refused
	 sent 0, rcvd 0
```
	-n : Skip DNS name resolution
	-vv : Very verbose
	-w : Timeout after 1 second
	-z : Don't send any data

Port numbers need no flags.

Also, nc lists ports highest to lowest.

It'll stream all refused connections as stderr.   In order to only view open connections, you'll need to combine stderr w/ stdout in order to pipe.
There are two ways to do this:
```bash
2>&1 |

|&
```

  
Wireshark capture:
![[ws_nc_scan.png]]
	Several TCP SYN packets were sent to ports 3390, 3389, and 3388 on packets 1, 3, and 7, respectively
	The server sent a TCP SYN-ACK packet from port 3389 on packet 4, indicating that the port is open
	The other portsactively rejected the connection attempt via a _RST-ACK_ packet.
	Packet 6, Netcat closed this connection by sending a _FIN-ACK_ packet.


### UDP Port Scanning
Uses a different mechanism as UDP is stateless.  
If the destination UDP port is open, the packet will be passed to the application layer and the response received will depend on how the application is programmed to respond to empty packets.

However, if the destination UDP port is closed, the target should respond with an ICMP port unreachable*, that is sent by the UDP/IP stack of the target machine.
	\*Note:  Can lead to FN's when firewalls or routers drop packets.
  
Ex:
```bash
nc -nv -u -z -w 1 192.168.50.149 120-123
	(UNKNOWN) [192.168.50.149] 123 (ntp) open
```
  
Wireshark capture:
![[ws_nc_uscan.png]]
	An empty UDP packet is sent to a specific port (packets 2, 3, 5, and 7)
	Packets 5, 7, and 9 are closed and show ICMP Destination unreachable
		\*Not reliable when the target is using a firewall.

### [Nmap](Tools.md#nmap)

De-facto tool for port scanning, though it offers numerous features beyond port scanning.
Some scans require access to [raw sockets](Raw%20Socket.md) which requires root privs.

It's important to understand the footprint that each nmap scan leaves on the wire and scanned host as it can be rather noisy and easily detectable.
Default nmap TCP scan will scan the 1000 most popular ports on a given machine.

Can monitor the traffic sent to a target host using [iptables](OS%20Commands.md#iptables):
```bash
sudo iptables -I INPUT 1 -s 192.168.50.149 -j ACCEPT
sudo iptables -I OUTPUT 1 -d 192.168.50.149 -j ACCEPT
sudo iptabels -Z
```
	-I option inserts a new rule into a given chain followed by the rule number (1)
		in this case, it includes both the INPUT (inbound) and OUTPUT (outbound) chains
	-s to specify a source IP
	-d to specify a destination IP
	-j to ACCEPT the traffic
	-Z to zero the packet & byte counters in all chains.

Generate some nmap traffic:
```bash
nmap 192.168.50.149
	Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-09 05:12 EST
	Nmap scan report for 192.168.50.149
	Host is up (0.10s latency).
	Not shown: 989 closed tcp ports (conn-refused)
	PORT     STATE SERVICE
	53/tcp   open  domain
	88/tcp   open  kerberos-sec
	135/tcp  open  msrpc
	139/tcp  open  netbios-ssn
	389/tcp  open  ldap
	445/tcp  open  microsoft-ds
	464/tcp  open  kpasswd5
	593/tcp  open  http-rpc-epmap
	636/tcp  open  ldapssl
	3268/tcp open  globalcatLDAP
	3269/tcp open  globalcatLDAPssl
	
	Nmap done: 1 IP address (1 host up) scanned in 10.95 seconds
```


View the traffic created by the scan:
```bash
sudo iptables -vn -L
	Chain INPUT (policy ACCEPT 1270 packets, 115K bytes)
	 pkts bytes target     prot opt in     out     source               destination
	 1196 47972 ACCEPT     all  --  *      *       192.168.50.149      0.0.0.0/0
	
	Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
	 pkts bytes target     prot opt in     out     source               destination
	
	Chain OUTPUT (policy ACCEPT 1264 packets, 143K bytes)
	 pkts bytes target     prot opt in     out     source               destination
	 1218 72640 ACCEPT     all  --  *      *       0.0.0.0/0            192.168.50.149
```
	According to the output, the default 1000-port scan generated ~72 KB of traffic.

Attempting a TCP port scan of all the ports would generate ~4MB of traffic, and attempting a full TCP scan of a Class C network would result in sending over 1000 MB of traffic.

#### Standard Scans

**-sS**:
Using a SYN (aka "stealth") scan helps reduce load on a network as it doesn't complete the TCP handshake.
	A SYN packet will be sent.  If the port is open, a SYN-ACK should be sent back.
	Because the 3-way handshake isn't completed, the info isn't passed to the app layer, and won't appear in any app logs.
	Faster & more efficient as fewer packets are sent and received.
	Default for nmap when using **sudo**

**-sT**
Using a TCP Connect scan will complete the 3-way handshake
	Takes much longer than a SYN scan.
	Doesn't require **sudo**, and is the default scan when not using root privs.

**-sU**
UDP scans use a combo of two different methods to determine if a port is open or closed.
	For most ports, it uses the "ICMP port unreachable" method by sending an empty packet to a given port
	For common ports (SNMP's 161), it sends a protocol-specific packet in an attempt to get a response from that port-bound app.
	Requires **sudo**

Can do a combination of SYN/ Connect and UDP scans.

**-O**
	OS Fingerprinting
	Attempts to guess the target's OS version by inspecting return packets as OS's have slightly different implementations of their TCP/IP stack.  
	Not always accurate - more like a best guess
	Add ***--osscan-guess*** to force nmap to print the guessed result even if not fully accurate.


_**[Banner Grabbing](Banner_Grabbing.md)**_ _can_ help ID services by inspecting banners (use w/ **-sT -A**), however, as banners can be manipulated by sysadmins, beware w/ fake info.  
	Has a significant impact on traffic amounts, so use wisely.


#### Network Sweeping

To deal w/ large volumes of hosts, or trying to conserve network traffic, you can use broad scans, then use more specific scans against hosts of interest.

Network sweeping w/ the **-sn** (ping sweep) option, the host discovery process consists of sending:  
• TCP SYN packet to port 443  
• TCP ACK packet to port 80  
• ICMP timestamp request

```bash
nmap -sn 192.168.50.1-253 -oG ping-sweep.txt
```
	Best to output results to a greppable format using **-oG** to a file

Scanning a specific port/s across a network tends to be more accurate than a ping sweep (**-sn**):
```bash
nmap -p 80 192.168.50.1-253 -oG web-sweep.txt

grep open web-sweep.txt | cut -d " " -f 2
```

Can also scan for top ports (**--top-ports=#**) determined using the */usr/share/nmap/nmap-services*
```bash
cat /usr/share/nmap/nmap-services 
	...
	finger    79/udp    0.000956
	http    80/sctp    0.000000    # www-http | www | World Wide Web HTTP
	http    80/tcp    0.484143    # World Wide Web HTTP
	http    80/udp    0.035767    # World Wide Web HTTP
	hosts2-ns    81/tcp    0.012056    # HOSTS2 Name Server
	hosts2-ns    81/udp    0.001005    # HOSTS2 Name Server
```
	1st name of the service
	2nd contains port number and protocol
	3rd is the "port frequency" - based on how often the port was found open during periodic research scans of the internet


### Test-NetConnection - Windows

LOLBIN PowerShell function checks if an IP responds to ICMP and whether a specified TCP port on the target host is open.

```powershell
Test-NetConnection -Port 445 192.168.50.151
	ComputerName     : 192.168.50.151
	RemoteAddress    : 192.168.50.151
	RemotePort       : 445
	InterfaceAlias   : Ethernet0
	SourceAddress    : 192.168.50.152
	TcpTestSucceeded : True
```
	TcpTestSucceeded : True indicates the port is open


Script the whole process in order to scan the first 1024 ports on the Domain Controller with a PowerShell one-liner.
To do so, instantiate a _TcpClient_ Socket object as _Test-NetConnection_ send additional traffic that is non needed for our purposes.

```powershell
1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("192.168.50.151", $_)) "TCP port $_ is open"} 2>$null
```
	Pipe the first 1024 integers into a for loop which assigns the integer to the variable $_
	Create a _Net.Sockets.TcpClient_ object & perform a TCP conn against the target IP on that port
	If successful, prompt a log message including the open port


## SMB Enumeration

Server Message Block
  
NetBIOS service listens on TCP port 139 & other UDP ports.
	SMB (TCP 445) and NetBIOS are two separate protocols

NetBIOS is an independent session layer protocol and service that allows computers on a local network to communicate with each other.
NetBIOS names are often very descriptive about the role of the host within the organization.

Though NetBIOS and SMB are two separate protocols and modern implementations of SMB can work w/o NetBIOS, _NetBIOS over TCP_ (NBT) is required for backwards compatibility and often enabled together.
  
Enumeration for both services go hand-in-hand.

### nmap

```bash
nmap -v -p 139,445 -oG smb.txt 192.168.50.1-254

cat smb.txt
	# Nmap 7.92 scan initiated Thu Mar 17 06:03:12 2022 as: nmap -v -p 139,445 -oG smb.txt 192.168.50.1-254
	# Ports scanned: TCP(2;139,445) UDP(0;) SCTP(0;) PROTOCOLS(0;)
	Host: 192.168.50.1 ()	Status: Down
	...
	Host: 192.168.50.21 ()	Status: Up
	Host: 192.168.50.21 ()	Ports: 139/closed/tcp//netbios-ssn///, 445/closed/tcp//microsoft-ds///
	...
	Host: 192.168.50.217 ()	Status: Up
	Host: 192.168.50.217 ()	Ports: 139/closed/tcp//netbios-ssn///, 445/closed/tcp//microsoft-ds///
	# Nmap done at Thu Mar 17 06:03:18 2022 -- 254 IP addresses (15 hosts up) scanned in 6.17 seconds
```

#### NSE SMB scripts:
```bash
ls -1 /usr/share/nmap/scripts/smb*
```

\*\*The SMB discovery script works only if SMBv1 is enabled on the target, which is not the default case on modern versions of Windows.
However, plenty of legacy systems are still running SMBv1.

##### SMB RCE Vuln:
```bash
nmap -v -p 139,445 --script smb-vuln-ms08-067 --script-args=unsafe=1 192.168.50.152
```
	w/ Script parameter set to **unsafe=1**, the scripts that run are almost/ totally guaranteed to crash a vulnerable system.
	  Use extreme caution when enabling this arg.


### [nbtscan](Tools.md#nbtscan)
More specialized tool used for specifically ID'ing NetBIOS information

```bash
sudo nbtscan -r 10.11.1.0/24
	Doing NBT name scan for addresses from 192.168.50.0/24
	
	IP address       NetBIOS Name     Server    User             MAC address
	------------------------------------------------------------------------------
	192.168.50.124   SAMBA            <server>  SAMBA            00:00:00:00:00:00
	192.168.50.134   SAMBAWEB         <server>  SAMBAWEB         00:00:00:00:00:00
	...
```
	-r specifies the originating UDP port as 137


### net view - Windows

```powershell
net view \\dc01 /all
	Shared resources at \\dc01
	
	Share name  Type  Used as  Comment
	
	-------------------------------------------------------------------------------
	ADMIN$      Disk           Remote Admin
	C$          Disk           Default share
	IPC$        IPC            Remote IPC
	NETLOGON    Disk           Logon server share
	SYSVOL      Disk           Logon server share
	The command completed successfully.
```
	/all lists the admin shares ending w/ $


### Removed from course:

#### [enum4linux](Tools.md#enum4linux)

```bash
enum4linux -U -o 192.168.1.200
```
	Attempt to get the userlist and OS info from the target IP

#### [smbclient](Tools.md#smbclient)

Ftp-like client to access SMB/CIFS resources on servers

#### [rpcclient](Tools.md#rpcclient)

Tool for executing client side MS-RPC functions

## SMTP Enumeration

**Simple Mail Transport Protocol**
	Port 25

### Linux:

Often abused to verify existing users on a mail server:
	**VRFY** _\<user\>_ - Verifies if the given user exists  
	**EXPN** _\<mailbox\>_ - Verifies whether a given mailbox exists 

Ex:
```bash
nc -nv 192.168.50.8 25
	(UNKNOWN) [192.168.50.8] 25 (smtp) open
	220 mail ESMTP Postfix (Ubuntu)
	VRFY root
	252 2.0.0 root
	VRFY idontexist
	550 5.1.1 <idontexist>: Recipient address rejected: User unknown in local recipient table
	^C
```
	Verified that 'root' user exists, but 'idontexist' user doesn't.


Can be automated with a python script which opens a TCP socket, connects to the SMTP server, and issues a VRFY command for a given username:
```python
#!/usr/bin/python

import socket
import sys

if len(sys.argv) != 3:
        print("Usage: vrfy.py <username> <target_ip>")
        sys.exit(0)

# Create a Socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

# Connect to the Server
ip = sys.argv[2]
connect = s.connect((ip,25))

# Receive the banner
banner = s.recv(1024)

print(banner)

# VRFY a user
user = (sys.argv[1]).encode()
s.send(b'VRFY ' + user + b'\r\n')
result = s.recv(1024)

print(result)

# Close the socket
s.close()
```


Run the script w/ the username as the first arg, and IP as second arg:
```bash
# Existing user output:
python3 smtp.py root 192.168.50.8
	b'220 mail ESMTP Postfix (Ubuntu)\r\n'
	b'252 2.0.0 root\r\n'

# Non-existing user output:
python3 smtp.py johndoe 192.168.50.8
	b'220 mail ESMTP Postfix (Ubuntu)\r\n'
	b'550 5.1.1 <johndoe>: Recipient address rejected: User unknown in local recipient table\r\n'
```

### Windows:

Of course, can scan for SMTP open ports on Windows:
```powershell
Test-NetConnection -Port 25 192.168.50.8

	ComputerName     : 192.168.50.8
	RemoteAddress    : 192.168.50.8
	RemotePort       : 25
	InterfaceAlias   : Ethernet0
	SourceAddress    : 192.168.50.152
	TcpTestSucceeded : True
```

In order to interact w/ SMTP on Windows, can install telnet:
```powershell
dism /online /Enable-Feature /FeatureName:TelnetClient
```
	\* Requires admin privileges!!
		If telnet exists on another computer, it may be easier to transfer it to the comp you currently are exploiting.

Once [telnet](OS%20Commands.md#telnet) is on the computer, you can interact w/ SMTP similarly to Linux:
```powershell
telnet 192.168.50.8 25
	220 mail ESMTP Postfix (Ubuntu)
	VRFY goofy
	550 5.1.1 <goofy>: Recipient address rejected: User unknown in local recipient table
	VRFY root
	252 2.0.0 root
```

### nmap enumeration:
```bash
sudo nmap -p 25 --script=smtp-enum* <target DOMAIN/ip>
```

## SNMP Enumeration

Simple Network Management Protocol - Protocol based on UDP used for managing a network.  
  
- Often misconfigured and easily susceptible to IP spoofing and replay attacks.  
- Traditionally has weak authentication schemes &` commonly left configured w/ default public and private community strings.  
- SNMP protocols 1, 2, and 2c offer no traffic encryption.  
  
SNMP community string is like a user ID or password that allows access to a router's, or other device's, statistics.  
	Ex: community names: public, private, manager, etc  
  
  
SNMP MIB - Management Information Base - Database containing information usually related to network management.  
Organized like a tree:  
- Branches represent different organizations or network functions.  
- Leaves of the tree (final endpoints) correspond to specific variable values that can be accessed and probed by an external user  
  
Ex default(?) OIDs and their values:

| OID                    | Values           |
| ---------------------- | ---------------- |
| 1.3.6.1.2.1.25.1.6.0   | System Processes |
| 1.3.6.1.2.25.4.2.1.2   | Running Programs |
| 1.3.6.1.2.1.25.4.2.1.4 | Processes Path   |
| 1.3.6.1.2.1.25.2.3.1.4 | Storage Units    |
| 1.3.6.1.1.25.6.3.1.2   | Software Name    |
| 1.3.6.1.4.1.77.1.2.25  | User Accounts    |
| 1.3.6.1.2.1.6.13.1.3   | TCP Local Ports  |

As SNMP is UDP based, we'll want to use **-sU** with [nmap](Tools.md#nmap)  
```bash
sudo nmap -sU --open -p 161 <ip> -oG open-snmp.txt
	Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-14 06:02 EDT
	Nmap scan report for 192.168.50.151
	Host is up (0.10s latency).
	
	PORT    STATE SERVICE
	161/udp open  snmp
	
	Nmap done: 1 IP address (1 host up) scanned in 0.49 seconds
```

### [onesixtyone](Tools.md#onesixtyone)

Can run a general query:
```bash
onesixtyone 192.168.247.0/24 public
```

OR

```bash
# Create file w/ list communities
echo public > community
echo private >> community
echo manager >> community

# Create file w/ list of all possible IPs
for ip in $(seq 1 254); do echo 192.168.247.$ip; done > ips

# Run against 161
onesixtyone -c community -i ips
	Scanning 254 hosts, 3 communities
	192.168.247.151 [public] Hardware: AMD64 Family 23 Model 1 Stepping 2 AT/AT COMPATIBLE - Software: Windows Version 6.3 (Build 17763 Multiprocessor Free)
```

Can then use the found host (**192.168.247.151**) and community (**public**) to scan with snmpwalk....

### [snmpwalk](Tools.md#snmpwalk)

We can probe and query SNMP values, provided we know the SNMP read-only community string, which in most cases is "public".

```bash
snmpwalk -c public -v1 -t 10 192.168.50.151
	iso.3.6.1.2.1.1.1.0 = STRING: "Hardware: Intel64 Family 6 Model 79 Stepping 1 AT/AT COMPATIBLE - Software: Windows Version 6.3 (Build 17763 Multiprocessor Free)"
	iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.311.1.1.3.1.3
	iso.3.6.1.2.1.1.3.0 = Timeticks: (78235) 0:13:02.35
	iso.3.6.1.2.1.1.4.0 = STRING: "admin@megacorptwo.com"
	iso.3.6.1.2.1.1.5.0 = STRING: "dc01.megacorptwo.com"
	iso.3.6.1.2.1.1.6.0 = ""
	iso.3.6.1.2.1.1.7.0 = INTEGER: 79
	iso.3.6.1.2.1.2.1.0 = INTEGER: 24
```
	-c - Specify community string  
	-v - Specify the SNMP version number  
	-t _\<n\>_- Specify timeout period to _n_ seconds  
	-Cc - Disable ascending OID check. Some agents (like LaserJets) return OIDs out of order.  
	-Cp - Print the number of variables found.

The output above can be used to obtain target email addresses.

```bash
snmpwalk -c public -v1 192.168.50.151 1.3.6.1.4.1.77.1.2.25
	iso.3.6.1.4.1.77.1.2.25.1.1.5.71.117.101.115.116 = STRING: "Guest"
	iso.3.6.1.4.1.77.1.2.25.1.1.6.107.114.98.116.103.116 = STRING: "krbtgt"
	iso.3.6.1.4.1.77.1.2.25.1.1.7.115.116.117.100.101.110.116 = STRING: "student"
	iso.3.6.1.4.1.77.1.2.25.1.1.13.65.100.109.105.110.105.115.116.114.97.116.111.114 = STRING: "Administrator"
```
	Good for Windows users

```bash
snmpwalk -c public -v1 192.168.50.151 1.3.6.1.2.1.25.4.2.1.2
	iso.3.6.1.2.1.25.4.2.1.2.1 = STRING: "System Idle Process"
	iso.3.6.1.2.1.25.4.2.1.2.4 = STRING: "System"
	iso.3.6.1.2.1.25.4.2.1.2.88 = STRING: "Registry"
	iso.3.6.1.2.1.25.4.2.1.2.260 = STRING: "smss.exe"
	iso.3.6.1.2.1.25.4.2.1.2.316 = STRING: "svchost.exe"
	iso.3.6.1.2.1.25.4.2.1.2.372 = STRING: "csrss.exe"
	iso.3.6.1.2.1.25.4.2.1.2.472 = STRING: "svchost.exe"
	iso.3.6.1.2.1.25.4.2.1.2.476 = STRING: "wininit.exe"
	iso.3.6.1.2.1.25.4.2.1.2.484 = STRING: "csrss.exe"
	iso.3.6.1.2.1.25.4.2.1.2.540 = STRING: "winlogon.exe"
	iso.3.6.1.2.1.25.4.2.1.2.616 = STRING: "services.exe"
	iso.3.6.1.2.1.25.4.2.1.2.632 = STRING: "lsass.exe"
	iso.3.6.1.2.1.25.4.2.1.2.680 = STRING: "svchost.exe"
	...
```
	Currently running processes

```bash
snmpwalk -c public -v1 192.168.50.151 1.3.6.1.2.1.25.6.3.1.2
	iso.3.6.1.2.1.25.6.3.1.2.1 = STRING: "Microsoft Visual C++ 2019 X64 Minimum Runtime - 14.27.29016"
	iso.3.6.1.2.1.25.6.3.1.2.2 = STRING: "VMware Tools"
	iso.3.6.1.2.1.25.6.3.1.2.3 = STRING: "Microsoft Visual C++ 2019 X64 Additional Runtime - 14.27.29016"
	iso.3.6.1.2.1.25.6.3.1.2.4 = STRING: "Microsoft Visual C++ 2015-2019 Redistributable (x86) - 14.27.290"
	iso.3.6.1.2.1.25.6.3.1.2.5 = STRING: "Microsoft Visual C++ 2015-2019 Redistributable (x64) - 14.27.290"
	iso.3.6.1.2.1.25.6.3.1.2.6 = STRING: "Microsoft Visual C++ 2019 X86 Additional Runtime - 14.27.29016"
	iso.3.6.1.2.1.25.6.3.1.2.7 = STRING: "Microsoft Visual C++ 2019 X86 Minimum Runtime - 14.27.29016"
	...
```
	Installed software

```bash
snmpwalk -c public -v1 192.168.50.151 1.3.6.1.2.1.6.13.1.3
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.88.0.0.0.0.0 = INTEGER: 88
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.135.0.0.0.0.0 = INTEGER: 135
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.389.0.0.0.0.0 = INTEGER: 389
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.445.0.0.0.0.0 = INTEGER: 445
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.464.0.0.0.0.0 = INTEGER: 464
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.593.0.0.0.0.0 = INTEGER: 593
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.636.0.0.0.0.0 = INTEGER: 636
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.3268.0.0.0.0.0 = INTEGER: 3268
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.3269.0.0.0.0.0 = INTEGER: 3269
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.5357.0.0.0.0.0 = INTEGER: 5357
	iso.3.6.1.2.1.6.13.1.3.0.0.0.0.5985.0.0.0.0.0 = INTEGER: 5985
	...
```
	Listening TCP ports

### Removed from course:

#### [snmpcheck](Tools.md#snmpcheck)


  
## Removed from course:

### [NFS Enumeration](6.x%20-%20NFS%20Enum.html.md)

[netdiscover](netdiscover.md) - Discover hosts  
  
